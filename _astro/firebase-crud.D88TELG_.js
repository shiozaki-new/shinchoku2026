import{F as f,s as b,a as w,I as g}from"./dashboard.astro_astro_type_script_index_0_lang.Dvj8_LcS.js";let c=null,a=null,d=null,s=null,i=null;async function F(){if(c){console.log("Firebase already initialized");return}console.log("Initializing Firebase..."),window.firebase||await m();try{c=firebase.initializeApp(f),a=c.firestore(),d=c.auth(),console.log("Firebase initialized successfully"),d.onAuthStateChanged(e=>{i=e,y(e),e?(console.log("User logged in:",e.email),p()):(console.log("User logged out"),s&&(s(),s=null))})}catch(e){console.error("Firebase initialization error:",e),r("Firebase初期化に失敗しました")}}async function m(){const e=["https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js","https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js","https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"];for(const o of e)await new Promise((n,u)=>{const l=document.createElement("script");l.src=o,l.onload=n,l.onerror=()=>u(new Error(`Failed to load ${o}`)),document.head.appendChild(l)});let t=0;for(;!window.firebase&&t<50;)await new Promise(o=>setTimeout(o,100)),t++;if(!window.firebase)throw new Error("Firebase SDK failed to load")}async function E(e,t){try{return await d.signInWithEmailAndPassword(e,t),{success:!0}}catch(o){return console.error("Login error:",o),{success:!1,error:o.message}}}async function T(){try{await d.signOut(),s&&(s(),s=null)}catch(e){console.error("Logout error:",e),r("ログアウトに失敗しました")}}function p(){s&&s(),s=a.collection("tasks").onSnapshot(e=>{if(e.empty)console.log("No tasks found, seeding initial data"),h();else{const t=e.docs.map(o=>({id:o.id,...o.data()}));console.log(`Loaded ${t.length} tasks from Firestore`),b(t),w()}},e=>{console.error("Firestore subscription error:",e),r("データの取得に失敗しました")})}async function h(){try{const e=a.batch();g.forEach(t=>{const o=a.collection("tasks").doc(t.id);e.set(o,{...t,createdAt:firebase.firestore.FieldValue.serverTimestamp()})}),await e.commit(),console.log("Initial data seeded successfully")}catch(e){console.error("Seed data error:",e),r("初期データの作成に失敗しました")}}async function I(e){if(!i)throw r("ログインが必要です"),new Error("Not authenticated");try{const t=await a.collection("tasks").add({...e,createdAt:firebase.firestore.FieldValue.serverTimestamp(),createdBy:i.uid});return console.log("Task created:",t.id),t.id}catch(t){throw console.error("Create task error:",t),r("タスクの作成に失敗しました"),t}}async function A(e,t){if(!i)throw r("ログインが必要です"),new Error("Not authenticated");try{await a.collection("tasks").doc(e).update({...t,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),updatedBy:i.uid}),console.log("Task updated:",e)}catch(o){throw console.error("Update task error:",o),r("タスクの更新に失敗しました"),o}}async function S(e){if(!i)throw r("ログインが必要です"),new Error("Not authenticated");if(confirm("本当にこのタスクを削除しますか?"))try{await a.collection("tasks").doc(e).delete(),console.log("Task deleted:",e)}catch(t){throw console.error("Delete task error:",t),r("タスクの削除に失敗しました"),t}}function y(e){const t=document.getElementById("btn-login"),o=document.getElementById("btn-logout"),n=document.getElementById("btn-edit-toggle");e?(t&&(t.style.display="none"),o&&(o.style.display="block"),n&&(n.disabled=!1)):(t&&(t.style.display="block"),o&&(o.style.display="none"),n&&(n.disabled=!0,document.body.classList.remove("edit-mode")))}function r(e){alert(e)}function L(){return i}export{I as createTask,S as deleteTask,L as getCurrentUser,F as initFirebase,E as login,T as logout,A as updateTask};
