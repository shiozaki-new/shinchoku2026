<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>星取進捗ダッシュボード</title>
  <!-- icons+meta start (managed) -->
  <!-- Favicon / Browser Icons -->
  <link rel="icon" href="/favicon.ico" sizes="16x16 32x32" type="image/x-icon">
  <link rel="icon" type="image/png" sizes="32x32" href="/icon-32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">

  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">

  <!-- PWA -->
  <link rel="manifest" href="/site.webmanifest">
  <meta name="application-name" content="星取進捗ダッシュボード">
  <meta name="apple-mobile-web-app-title" content="星取進捗ダッシュボード">
  <meta name="theme-color" content="#0d1117">
  <meta name="format-detection" content="telephone=no">
  <meta name="color-scheme" content="light">

  <!-- Windows -->
  <meta name="msapplication-TileColor" content="#0d1117">

  <!-- Canonical -->
  <!-- TODO: 本番ドメインに差し替え -->
  <link rel="canonical" href="https://example.com/">

  <!-- SEO -->
  <meta name="description" content="部門横断のタスク進捗を可視化し、緊急・注意・順調を一目で把握できる社内ダッシュボード。Firebase認証/Firestoreでリアルタイム更新。">
  <meta name="robots" content="index,follow">

  <!-- OGP -->
  <!-- TODO: SITE_URL を本番に変更 -->
  <meta property="og:locale" content="ja_JP">
  <meta property="og:type" content="website">
  <meta property="og:site_name" content="星取進捗ダッシュボード">
  <meta property="og:title" content="星取進捗ダッシュボード">
  <meta property="og:description" content="部門横断のタスク進捗を可視化し、緊急・注意・順調を一目で把握できる社内ダッシュボード。Firebase認証/Firestoreでリアルタイム更新。">
  <meta property="og:url" content="https://example.com/">
  <!-- NOTE: ogp.png が存在しないため og:image は省略 -->

  <!-- Twitter -->
  <!-- TODO: SITE_URL を本番に変更 -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="星取進捗ダッシュボード">
  <meta name="twitter:description" content="部門横断のタスク進捗を可視化し、緊急・注意・順調を一目で把握できる社内ダッシュボード。Firebase認証/Firestoreでリアルタイム更新。">
  <!-- NOTE: twitter-card.png が存在しないため twitter:image は省略 -->
  <!-- icons+meta end (managed) -->

  <style>
    /* ===================================================
       十式準拠 星取進捗ダッシュボード CSS
       ⑩継：Apple社内ツール風UI（余白・角丸・薄影・タイポ階層）
    =================================================== */

    :root {
      /* ②理：期限ステータス色定義 */
      --color-zetsu: #FF3B30;      /* 絶期限：赤 */
      --color-zetsu-text: #FFFFFF;
      --color-ran: #FFCC00;        /* 乱期限：黄 */
      --color-ran-text: #1D1D1F;
      --color-jun: #007AFF;        /* 循期限：青 */
      --color-jun-text: #FFFFFF;

      /* Apple風ベースカラー */
      --bg-primary: #F5F5F7;
      --bg-secondary: #FFFFFF;
      --bg-modal: rgba(0, 0, 0, 0.5);
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --border-color: #D2D2D7;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.16);

      /* タイポグラフィ */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 17px;
      --font-size-xl: 22px;
      --font-size-2xl: 28px;

      /* 角丸 */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;

      /* 余白 */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;

      /* ヘッダーボタン統一寸法 */
      --btn-h: 36px;
      --btn-px: 14px;
      --btn-radius: 9999px;
      --btn-fs: 14px;
      --btn-fw: 600;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--text-primary);
      background: var(--bg-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Global: prevent accidental horizontal scroll on mobile */
    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    /* ===================================================
       ヘッダー（部署ヘッダー）
    =================================================== */
    .department-header {
      background: var(--bg-secondary);
      padding: var(--space-md) var(--space-lg);
      box-shadow: var(--shadow-light);
      /* Grid 2列: 左=タイトル 右=ボタン */
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-areas: 'title actions';
      align-items: center;
      column-gap: var(--space-md);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .department-title {
      grid-area: title;
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--text-primary);
      min-width: 0; /* grid子要素の溢れ対策 */
    }

    .header-actions {
      grid-area: actions;
      justify-self: end;
      display: flex;
      gap: var(--space-sm);
      align-items: center;
      flex-wrap: nowrap;
      min-width: 0;
    }

    /* ヘッダーボタン共通スタイル - 高さ・文字サイズ・余白・丸み統一 */
    .header-actions .btn-hoshitori,
    .header-actions .btn-hoshitori-table,
    .header-actions .btn-worklog,
    .header-actions .btn-login {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: var(--btn-h);
      padding: 0 var(--btn-px);
      border-radius: var(--btn-radius);
      font-size: var(--btn-fs);
      font-weight: var(--btn-fw);
      line-height: 1;
      letter-spacing: 0.01em;
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      border-width: 1px;
      border-style: solid;
      box-shadow: 0 1px 2px rgba(16, 24, 40, 0.06);
      /* ラベル折返し禁止 - 常に1行 */
      white-space: nowrap;
      word-break: keep-all;
      text-wrap: nowrap;
    }

    /* 星取管理表ボタン - ①認：入口 */
    .btn-hoshitori {
      background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
      color: white;
      border-color: transparent; /* グラデ系は透明枠で高さ統一 */
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-hoshitori:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .btn-hoshitori:active {
      transform: translateY(0);
    }

    /* ログインボタン */
    .btn-login {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-color: var(--border-color);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-login:hover {
      background: var(--bg-primary);
    }

    .btn-login.logged-in {
      background: #34C759;
      color: white;
      border-color: #34C759;
    }

    /* 作業完了ログボタン（見た目は既存とあわせる） */
    .btn-worklog {
      background: #EDE9FE;
      color: #5B21B6;
      border-color: #DDD6FE;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-worklog:hover { background: #DDD6FE; }

    /* iPhone表示時（小画面・タッチ環境）でヘッダーフォントをさらに小さく - 1行に収める */
    @media screen and (max-width: 430px) and (hover: none) and (pointer: coarse) {
      /* Header: 1列グリッドに変更し、ボタンは下段へ */
      .department-header {
        grid-template-columns: 1fr;
        grid-template-areas: 'title' 'actions';
        row-gap: 6px;
        justify-items: center; /* 子要素の中央寄せ */
        /* iOS safe areas */
        padding-top: calc(env(safe-area-inset-top) + var(--space-sm));
        padding-left: calc(env(safe-area-inset-left) + var(--space-md));
        padding-right: calc(env(safe-area-inset-right) + var(--space-md));
      }
      .header-actions {
        justify-self: center;
        flex-wrap: wrap;
        justify-content: center; /* ボタン群を中央寄せ */
      }
      .department-title {
        font-size: calc(var(--font-size-xl) - 6px);
        justify-self: center;
        text-align: center;
      }
      .header-actions { gap: 6px; }
      .header-actions .btn-hoshitori,
      .header-actions .btn-hoshitori-table,
      .header-actions .btn-worklog,
      .header-actions .btn-login {
        font-size: clamp(10px, 3.2vw, 12px); /* iPhone幅で1行に収まる可変値 */
        padding: 0 10px; /* 左右を少し削る */
        letter-spacing: 0; /* 詰めて収まりを良くする */
        max-width: 100%;
      }
      /* main padding a bit tighter on very small screens */
      .main-content { padding: var(--space-md); }
    }

    /* より狭い端末（SE等）に保険 */
    @media screen and (max-width: 375px) and (hover: none) and (pointer: coarse) {
      .header-actions {
        gap: 4px;
      }
      .department-header { row-gap: 6px; justify-items: center; }
      .header-actions { flex-wrap: wrap; justify-self: center; justify-content: center; }
      .department-title { justify-self: center; text-align: center; }
      .header-actions .btn-hoshitori,
      .header-actions .btn-hoshitori-table,
      .header-actions .btn-worklog,
      .header-actions .btn-login {
        font-size: clamp(10px, 3.8vw, 11.5px);
        padding: 0 8px;
      }
      .main-content { padding: var(--space-sm) var(--space-md); }
    }

    /* ===================================================
       モーダル - ①認：モーダル表示
    =================================================== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-modal);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: var(--space-lg);
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-heavy);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-primary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    /* ===================================================
       期限リストセクション - ③衡：表示バランス
    =================================================== */
    .deadline-section {
      margin-bottom: var(--space-lg);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .section-badge {
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-badge.zetsu {
      background: var(--color-zetsu);
      color: var(--color-zetsu-text);
    }

    .section-badge.ran {
      background: var(--color-ran);
      color: var(--color-ran-text);
    }

    .section-badge.jun {
      background: var(--color-jun);
      color: var(--color-jun-text);
    }

    .section-badge.nodeadline {
      background: #B0B0B0;
      color: #000000;
    }

    .section-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    .section-count {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-left: auto;
    }

    /* タスクリスト */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .task-list-empty {
      text-align: center;
      padding: var(--space-lg);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
    }

    /* タスクカード */
    .task-card {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      transition: all 0.2s ease;
    }

    .task-card:hover {
      box-shadow: var(--shadow-light);
    }

    .task-card.zetsu {
      border-left: 4px solid var(--color-zetsu);
    }

    .task-card.ran {
      border-left: 4px solid var(--color-ran);
    }

    .task-card.jun {
      border-left: 4px solid var(--color-jun);
    }

    .task-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
    }

    .task-title {
      font-size: var(--font-size-base);
      font-weight: 500;
      flex: 1;
    }

    .task-title-input {
      font-size: var(--font-size-base);
      font-weight: 500;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: var(--space-xs) var(--space-sm);
      width: 100%;
      font-family: inherit;
    }

    .task-deadline {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      white-space: nowrap;
      margin-left: var(--space-sm);
    }

    .task-deadline-input {
      font-size: var(--font-size-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: var(--space-xs) var(--space-sm);
      font-family: inherit;
    }

    /* ===================================================
       HPバー風ゲージ - ②理：ポケモンHPバー風
    =================================================== */
    .hp-bar-container {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .hp-bar-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      min-width: 20px;
    }

    .hp-bar-wrapper {
      flex: 1;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .hp-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease, background 0.3s ease;
    }

    .hp-bar-fill.zetsu {
      background: linear-gradient(90deg, var(--color-zetsu) 0%, #FF6961 100%);
    }

    .hp-bar-fill.ran {
      background: linear-gradient(90deg, var(--color-ran) 0%, #FFE066 100%);
    }

    .hp-bar-fill.jun {
      background: linear-gradient(90deg, var(--color-jun) 0%, #5AC8FA 100%);
    }

    .hp-bar-value {
      font-size: var(--font-size-xs);
      font-weight: 600;
      min-width: 36px;
      text-align: right;
    }

    /* 進捗スライダー（管理者用） */
    .progress-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #E5E5EA;
      outline: none;
      cursor: pointer;
    }

    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--color-jun);
      box-shadow: var(--shadow-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .progress-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .progress-slider.zetsu::-webkit-slider-thumb {
      border-color: var(--color-zetsu);
    }

    .progress-slider.ran::-webkit-slider-thumb {
      border-color: var(--color-ran);
    }

    .progress-slider.jun::-webkit-slider-thumb {
      border-color: var(--color-jun);
    }

    /* Firefox対応 */
    .progress-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--color-jun);
      box-shadow: var(--shadow-light);
      cursor: pointer;
    }

    /* ===================================================
       区切り線 - ④縁：構造
    =================================================== */
    .section-divider {
      height: 1px;
      background: var(--border-color);
      margin: var(--space-lg) 0;
    }

    /* ===================================================
       管理者用アクション - ⑥許：権限
    =================================================== */
    .admin-actions {
      display: none;
    }

    .admin-mode .admin-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .task-actions {
      display: none;
      gap: var(--space-xs);
      margin-left: var(--space-sm);
    }

    .admin-mode .task-actions {
      display: flex;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-icon.delete:hover {
      background: #FFEBEE;
      color: var(--color-zetsu);
    }

    .btn-add-task {
      background: var(--bg-secondary);
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      width: 100%;
      cursor: pointer;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      transition: all 0.2s ease;
      margin-top: var(--space-md);
    }

    .btn-add-task:hover {
      border-color: var(--color-jun);
      color: var(--color-jun);
      background: rgba(0, 122, 255, 0.05);
    }

    /* ===================================================
       ログインモーダル
    =================================================== */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-modal);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: var(--space-lg);
      backdrop-filter: blur(4px);
    }

    .login-modal.active {
      display: flex;
    }

    .login-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      width: 100%;
      max-width: 360px;
      box-shadow: var(--shadow-heavy);
    }

    .login-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: 500;
      margin-bottom: var(--space-xs);
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-jun);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .btn-submit {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: var(--space-md);
    }

    .btn-submit:hover {
      opacity: 0.9;
    }

    .btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .login-error {
      color: var(--color-zetsu);
      font-size: var(--font-size-sm);
      text-align: center;
      margin-top: var(--space-sm);
      display: none;
    }

    .login-error.show {
      display: block;
    }

    .login-close {
      position: absolute;
      top: var(--space-md);
      right: var(--space-md);
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-primary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
    }

    /* ===================================================
       ローディング
    =================================================== */
    .loading {
      text-align: center;
      padding: var(--space-xl);
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--bg-primary);
      border-top-color: var(--color-jun);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-md);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===================================================
       フッター情報
    =================================================== */
    .modal-footer {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-color);
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      text-align: center;
      flex-shrink: 0;
    }

    /* ===================================================
       レスポンシブ - ⑧乱対応
    =================================================== */
    @media (max-width: 640px) {
      .modal-container {
        max-height: 100vh;
        border-radius: 0;
      }

      .modal-body {
        padding: var(--space-md);
      }

      .task-header {
        flex-direction: column;
        gap: var(--space-xs);
      }

      .task-deadline {
        margin-left: 0;
      }

      .department-header {
        padding: var(--space-sm) var(--space-md);
      }

      .department-title {
        font-size: var(--font-size-lg);
      }
    }

    /* ===================================================
       メインコンテンツ（ダミー）
    =================================================== */
    .main-content {
      padding: var(--space-xl);
      max-width: 1200px;
      margin: 0 auto;
    }

    .placeholder-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-light);
      text-align: center;
      color: var(--text-secondary);
    }

    /* ===================================================
       タスク残り日数表示
    =================================================== */
    .task-remaining {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }

    .task-remaining.overdue {
      color: var(--color-zetsu);
      font-weight: 500;
    }

    /* 作業完了ログ モーダル */
    .worklog-modal { display:none; position:fixed; inset:0; background: var(--bg-modal); z-index:1000; justify-content:center; align-items:center; padding: var(--space-lg); backdrop-filter: blur(4px); }
    .worklog-modal.active { display:flex; }
    .worklog-container { background: var(--bg-secondary); border-radius: var(--radius-xl); width:100%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-heavy); display:flex; flex-direction:column; }
    .worklog-header { padding: var(--space-lg); border-bottom:1px solid var(--border-color); display:flex; align-items:center; justify-content: space-between; }
    .worklog-title { font-size: var(--font-size-xl); font-weight:600; }
    .worklog-body { padding: var(--space-lg); overflow:auto; flex:1; }
    .worklog-table { width:100%; border-collapse: collapse; font-size: var(--font-size-sm); }
    .worklog-table th, .worklog-table td { border-top:1px solid var(--border-color); padding: 10px 12px; text-align:left; }
    .worklog-table th { background: var(--bg-primary); position: sticky; top: 0; z-index: 1; }

    /* メインハイライト（絶期限・乱期限常時表示） */
    .main-highlights {
      margin-bottom: var(--space-lg);
    }

    .main-highlights .deadline-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-light);
      margin-bottom: var(--space-md);
    }

    .main-highlights .deadline-section.zetsu {
      border: 3px solid var(--color-zetsu);
    }

    .main-highlights .deadline-section.ran {
      border: 3px solid var(--color-ran);
    }

    .main-highlights .deadline-section.jun {
      border: 3px solid var(--color-jun);
    }

    .main-highlights .deadline-section.nodeadline {
      border: 3px solid #B0B0B0;
    }

    .main-highlights .section-header {
      margin-bottom: var(--space-md);
    }

    .main-highlights-empty {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-light);
      text-align: center;
      color: var(--text-secondary);
    }
  </style>
  <!-- Inlined from src/hoshitori/hoshitori.css -->
  <style>
  /* ===================================================
     星取管理表（業務担当一覧表）CSS (inlined)
     =================================================== */
  .btn-hoshitori-table {
    background: linear-gradient(180deg, #FF9500 0%, #CC7700 100%);
    color: white;
    border-color: transparent; /* グラデ系は透明枠で高さ統一 */
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .btn-hoshitori-table:hover { transform: translateY(-1px); box-shadow: var(--shadow-medium); }
  .btn-hoshitori-table:active { transform: translateY(0); }

  .hoshitori-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-modal); z-index: 1000; justify-content: center; align-items: center; padding: var(--space-lg); backdrop-filter: blur(4px); }
  .hoshitori-modal.active { display: flex; }
  /* 操作性向上（UI変更なし）: モーダルが開いている間の背面スクロールを無効化 */
  body.modal-open { overflow: hidden; }
  /* iOSのスクロール連鎖/バウンスを抑制 */
  .hoshitori-modal, .worklog-modal, .login-modal, #dashboardModal { overscroll-behavior: contain; }
  .hoshitori-container { background: var(--bg-secondary); border-radius: var(--radius-xl); width: 100%; max-width: 900px; max-height: 90vh; overflow: hidden; box-shadow: var(--shadow-heavy); display: flex; flex-direction: column; }
  .hoshitori-header { padding: var(--space-lg); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .hoshitori-title { font-size: var(--font-size-xl); font-weight: 600; display: flex; align-items: center; gap: var(--space-sm); }
  .hoshitori-title::before { content: "★"; color: #FF9500; }
  /* 上方向の余白はテーブル側(margin-top)で与え、stickyの挙動を安定させる */
  .hoshitori-body { padding: 0 var(--space-lg) var(--space-lg); overflow: auto; flex: 1; background: #fff; }
  .hoshitori-body { -webkit-overflow-scrolling: touch; overscroll-behavior: contain; }
  .hoshitori-table-wrapper { overflow-x: auto; margin: var(--space-lg) 0 var(--space-lg); background: #fff; }
  .hoshitori-table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: var(--font-size-sm); }
  .hoshitori-table th, .hoshitori-table td { border: 1px solid var(--border-color); padding: var(--space-sm) var(--space-md); text-align: center; vertical-align: middle; }
  .hoshitori-table th { background: #fff; font-weight: 600; position: sticky; top: 0; z-index: 10; }
  .hoshitori-table thead th:first-child { border-left: 1px solid var(--border-color); }
  .hoshitori-table thead th:last-child { border-right: 1px solid var(--border-color); }
  .hoshitori-table th:first-child { text-align: left; min-width: 200px; }
  .hoshitori-table th.member-col { min-width: 80px; }
  .hoshitori-table tr.category-row { background: #E5E5EA; }
  .hoshitori-table tr.category-row td { font-weight: 600; text-align: left; padding-left: var(--space-md); }
  .hoshitori-table tr.category-row td:first-child { display: flex; align-items: center; gap: var(--space-sm); }
  .hoshitori-table tr.task-row td:first-child { text-align: left; padding-left: var(--space-xl); display: flex; align-items: center; gap: var(--space-sm); }
  .owner-cell { cursor: default; transition: all 0.2s ease; user-select: none; min-height: 40px; }
  .owner-cell.editable { cursor: pointer; }
  .owner-cell.editable:hover { background: rgba(0, 122, 255, 0.1); }
  .owner-cell .owner-mark { font-size: calc(var(--font-size-xl) - 12px); font-weight: bold; color: var(--color-jun); }
  .admin-panel { display: none; padding: var(--space-md); background: var(--bg-primary); border-radius: var(--radius-md); margin-top: var(--space-md); }
  .admin-mode .admin-panel { display: block; }
  .admin-panel-title { font-size: var(--font-size-sm); font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-sm); }
  .admin-buttons { display: flex; gap: var(--space-sm); flex-wrap: wrap; }
  .btn-admin { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: var(--space-xs) var(--space-md); font-size: var(--font-size-sm); cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: var(--space-xs); }
  .btn-admin:hover { border-color: var(--color-jun); color: var(--color-jun); }
  .btn-admin.danger:hover { border-color: var(--color-zetsu); color: var(--color-zetsu); }
  .inline-edit { border: 1px solid var(--color-jun); border-radius: var(--radius-sm); padding: var(--space-xs) var(--space-sm); font-size: var(--font-size-sm); font-family: inherit; width: 100%; max-width: 200px; }
  .operation-log { margin-top: var(--space-lg); padding: var(--space-md); background: var(--bg-primary); border-radius: var(--radius-md); max-height: 150px; overflow-y: auto; }
  .operation-log-title { font-size: var(--font-size-sm); font-weight: 600; color: var(--text-secondary); margin-bottom: var(--space-sm); }
  .log-entry { font-size: var(--font-size-xs); color: var(--text-secondary); padding: var(--space-xs) 0; border-bottom: 1px solid var(--border-color); }
  .log-entry:last-child { border-bottom: none; }
  .row-actions { display: none; gap: var(--space-xs); }
  .admin-mode .row-actions { display: flex; }
  .btn-row-action { width: 24px; height: 24px; border: none; background: transparent; border-radius: var(--radius-sm); cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); font-size: 12px; transition: all 0.2s ease; }
  .btn-row-action:hover { background: var(--bg-secondary); color: var(--text-primary); }
  .btn-row-action.delete:hover { background: #FFEBEE; color: var(--color-zetsu); }
  .hoshitori-footer { padding: var(--space-md) var(--space-lg); border-top: 1px solid var(--border-color); font-size: var(--font-size-xs); color: var(--text-secondary); text-align: center; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
  .hoshitori-loading { text-align: center; padding: var(--space-xl); color: var(--text-secondary); }
  .hoshitori-empty { text-align: center; padding: var(--space-xl); color: var(--text-secondary); }

  /* Drag & Drop Sorting */
  .drag-handle { cursor: grab; padding: 4px 8px; color: var(--text-secondary); user-select: none; touch-action: none; display: none; }
  .admin-mode .drag-handle { display: inline-flex; align-items: center; }
  .drag-handle:hover { color: var(--text-primary); }
  .drag-handle:active { cursor: grabbing; }
  .drag-handle svg { width: 16px; height: 16px; pointer-events: none; }
  .hoshitori-table tr.dragging { opacity: 0.5; background: #d0e8ff !important; }
  .hoshitori-table tr.drop-target-above td { box-shadow: inset 0 2px 0 0 var(--color-jun); }
  .hoshitori-table tr.drop-target-below td { box-shadow: inset 0 -2px 0 0 var(--color-jun); }
  .hoshitori-table tr.reorder-focus td:first-child { outline: 2px solid var(--color-jun); outline-offset: -2px; }

  /* Dashboard Task Card Drag & Drop Sorting */
  .task-card.dragging { opacity: .6; background: #eef6ff; }
  .task-card.drop-target-above { box-shadow: inset 0 2px 0 0 var(--color-jun); }
  .task-card.drop-target-below { box-shadow: inset 0 -2px 0 0 var(--color-jun); }
  .task-card .drag-handle { margin-right: var(--space-sm); }
  /* メインダッシュボード（トップページ）ではドラッグハンドル非表示 */
  .main-highlights .task-card .drag-handle { display: none !important; }

  /* ===================================================
     優先度キラキラエフェクト（枠線だけがキラキラ流れる）
     priority: 3=最重要(虹), 2=重要(金), 1=優先(銀), 0=普通
     グラデーション背景を流し、内側に白背景を重ねて枠だけキラキラ
  =================================================== */
  @keyframes border-flow {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
  }

  /* 優先度付きカードの共通設定 */
  .task-card.priority-1,
  .task-card.priority-2,
  .task-card.priority-3 {
    position: relative;
    border: none !important;
    padding: calc(var(--space-md) + 4px);
    background-size: 200% 200%;
  }
  /* 内側のコンテンツはz-index上げる */
  .task-card.priority-1 > *,
  .task-card.priority-2 > *,
  .task-card.priority-3 > * {
    position: relative;
    z-index: 1;
  }
  /* 内側の白背景（エフェクトなし） */
  .task-card.priority-1::after,
  .task-card.priority-2::after,
  .task-card.priority-3::after {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    background: var(--bg-primary);
    border-radius: calc(var(--radius-md) - 2px);
    z-index: 0;
  }

  /* 優先（銀色キラキラ枠） - priority-1 */
  .task-card.priority-1 {
    background: linear-gradient(90deg, #a0a0a0, #d8d8d8, #ffffff, #d8d8d8, #a0a0a0, #c0c0c0, #ffffff, #a0a0a0);
    background-size: 200% 200%;
    animation: border-flow 6s linear infinite;
  }

  /* 重要（金色キラキラ枠） - priority-2 */
  .task-card.priority-2 {
    background: linear-gradient(90deg, #b8860b, #ffd700, #fffacd, #ffd700, #ff8c00, #ffd700, #fffacd, #b8860b);
    background-size: 200% 200%;
    animation: border-flow 5s linear infinite;
  }

  /* 最重要（虹色キラキラ枠） - priority-3 */
  .task-card.priority-3 {
    background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3, #54a0ff, #5f27cd, #ff6b6b, #feca57, #48dbfb);
    background-size: 300% 300%;
    animation: border-flow 4s linear infinite;
  }

  /* 優先度ボタン */
  .btn-priority {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }
  .btn-priority:hover {
    background: var(--bg-secondary);
    transform: scale(1.1);
  }
  .btn-priority[data-priority="0"] { color: var(--text-secondary); }
  .btn-priority[data-priority="1"] { color: #a0a0a0; }
  .btn-priority[data-priority="2"] { color: #ffd700; }
  .btn-priority[data-priority="3"] { color: #ff6b6b; }

  /* Floating Admin Bar (FAB) */
  .admin-fab {
    position: fixed;
    bottom: var(--space-xl);
    right: var(--space-xl);
    z-index: 3500;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
    color: white;
    font-size: 28px;
    font-weight: 300;
    cursor: pointer;
    box-shadow: var(--shadow-heavy);
    display: none;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }
  .admin-mode .admin-fab { display: flex; }
  .admin-fab:hover { opacity: 0.9; transform: scale(1.05); }
  .admin-fab:active { transform: scale(0.98); }
  .admin-fab:focus-visible { outline: 2px solid #0056CC; outline-offset: 2px; }
  .admin-fab.open { transform: rotate(45deg); }

  .admin-fab-menu {
    position: fixed;
    right: var(--space-xl);
    bottom: calc(var(--space-xl) + 68px);
    max-width: 280px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-heavy);
    padding: var(--space-md);
    display: none;
    z-index: 3500;
  }
  .admin-fab-menu.open { display: block; }
  .admin-fab-menu-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
  }
  .admin-fab-actions { display: flex; flex-direction: column; gap: var(--space-xs); }
  .admin-fab-btn {
    padding: 8px 12px;
    font-size: var(--font-size-sm);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    background: var(--bg-secondary);
    color: var(--text-primary);
    cursor: pointer;
    text-align: left;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  .admin-fab-btn:hover { border-color: var(--color-jun); color: var(--color-jun); }
  .admin-fab-btn:focus-visible { outline: 2px solid #0056CC; outline-offset: 2px; }
  .admin-fab-btn.danger:hover { border-color: var(--color-zetsu); color: var(--color-zetsu); }
  .admin-fab-shortcut {
    margin-left: auto;
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    background: var(--bg-primary);
    padding: 2px 6px;
    border-radius: 3px;
  }

  @media (max-width: 640px) {
    .hoshitori-container { max-height: 100vh; border-radius: 0; }
    /* sticky安定化: モバイルでも上パディングは0、余白はテーブル側で確保 */
    .hoshitori-body { padding: 0 var(--space-md) var(--space-md); }
    .hoshitori-table-wrapper { margin: var(--space-md) 0 var(--space-md); }
    .hoshitori-table { font-size: var(--font-size-xs); }
    .hoshitori-table th, .hoshitori-table td { padding: var(--space-xs) var(--space-sm); }
    .admin-fab { bottom: var(--space-lg); right: var(--space-lg); width: 52px; height: 52px; font-size: 24px; }
    .admin-fab-menu { right: var(--space-lg); bottom: calc(var(--space-lg) + 60px); max-width: calc(100vw - 48px); }
  }

  /* Sticky Header for Hoshitori Table (CSS only, no JS overlay) */
  /* 重要: sticky が効くためには、スクロールコンテナ(.hoshitori-body)と thead の間に
     overflow: auto/scroll/hidden を持つ要素があってはならない */
  .hoshitori-body { position: relative; overflow: auto; }
  .hoshitori-table-wrapper { position: relative; overflow: visible; }
  .hoshitori-table { border-collapse: separate; border-spacing: 0; }
  .hoshitori-table thead { background: #fff; }
  /* 行全体も固定して背景を保つ（空白が透けないように） */
  .hoshitori-table thead tr {
    position: sticky;
    top: 0;
    z-index: 12;                 /* 個別th(z-index:20)より下でOK。背景として機能 */
    background: #fff;
    border-bottom: 1px solid var(--border-color);
  }
  .hoshitori-table thead th {
    position: sticky;
    top: 0;
    z-index: 20;
    background: #fff;
    border-bottom: 1px solid var(--border-color);
  }
  .hoshitori-table thead th:first-child { border-left: 1px solid var(--border-color); }
  .hoshitori-table thead th:last-child { border-right: 1px solid var(--border-color); }

  /* ===================================================
     Accessibility: Focus-visible for keyboard navigation
  =================================================== */
  .header-actions button:focus-visible,
  .btn-icon:focus-visible,
  .btn-admin:focus-visible,
  .modal-close:focus-visible,
  .login-close:focus-visible,
  .btn-hoshitori-table:focus-visible,
  .btn-hoshitori:focus-visible,
  .btn-worklog:focus-visible,
  .btn-login:focus-visible,
  .btn-submit:focus-visible,
  .btn-add-task:focus-visible,
  .btn-row-action:focus-visible {
    outline: 2px solid #0056CC;
    outline-offset: 2px;
  }

  /* ===================================================
     Accessibility: Reduced motion preference
  =================================================== */
  @media (prefers-reduced-motion: reduce) {
    .loading-spinner {
      animation: none;
    }
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* ===================================================
     App Dialog & Toast Styles
  =================================================== */
  .app-dialog-overlay {
    display: flex;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: var(--bg-modal);
    z-index: 3000;
    justify-content: center;
    align-items: center;
    padding: var(--space-lg);
    backdrop-filter: blur(4px);
  }
  .app-dialog-container {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    width: 100%;
    max-width: 400px;
    box-shadow: var(--shadow-heavy);
    position: relative;
  }
  .app-dialog-title {
    font-size: var(--font-size-xl);
    font-weight: 600;
    margin-bottom: var(--space-md);
    color: var(--text-primary);
  }
  .app-dialog-message {
    font-size: var(--font-size-base);
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
    line-height: 1.6;
  }
  .app-dialog-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    margin-bottom: var(--space-xs);
    color: var(--text-secondary);
  }
  .app-dialog-input {
    width: 100%;
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    font-family: inherit;
    margin-bottom: var(--space-sm);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }
  .app-dialog-input:focus {
    outline: none;
    border-color: var(--color-jun);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
  }
  .app-dialog-input.error {
    border-color: var(--color-zetsu);
  }
  .app-dialog-error {
    color: var(--color-zetsu);
    font-size: var(--font-size-sm);
    margin-bottom: var(--space-sm);
    display: none;
  }
  .app-dialog-error.show {
    display: block;
  }
  .app-dialog-remember {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    cursor: pointer;
  }
  .app-dialog-remember input {
    width: 16px;
    height: 16px;
    cursor: pointer;
  }
  .app-dialog-buttons {
    display: flex;
    gap: var(--space-sm);
    justify-content: flex-end;
  }
  .app-dialog-btn {
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-size: var(--font-size-base);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-color);
  }
  .app-dialog-btn-cancel {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }
  .app-dialog-btn-cancel:hover {
    background: var(--bg-primary);
  }
  .app-dialog-btn-confirm {
    background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
    color: white;
    border-color: transparent;
  }
  .app-dialog-btn-confirm:hover {
    opacity: 0.9;
  }
  .app-dialog-btn-danger {
    background: linear-gradient(180deg, #FF3B30 0%, #CC2D26 100%);
    color: white;
    border-color: transparent;
  }
  .app-dialog-btn-danger:hover {
    opacity: 0.9;
  }
  .app-dialog-btn:focus-visible {
    outline: 2px solid #0056CC;
    outline-offset: 2px;
  }
  .app-dialog-select-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    max-height: 300px;
    overflow-y: auto;
  }
  .app-dialog-select-item {
    padding: var(--space-sm) var(--space-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    cursor: pointer;
    text-align: left;
    font-size: var(--font-size-base);
    transition: all 0.2s ease;
  }
  .app-dialog-select-item:hover {
    border-color: var(--color-jun);
    background: rgba(0, 122, 255, 0.05);
  }
  .app-dialog-select-item:focus-visible {
    outline: 2px solid #0056CC;
    outline-offset: 2px;
  }
  .app-toast {
    position: fixed;
    bottom: var(--space-xl);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text-primary);
    color: var(--bg-secondary);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-size: var(--font-size-sm);
    box-shadow: var(--shadow-medium);
    z-index: 4000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .app-toast.show {
    opacity: 1;
  }
  </style>
</head>
<body>
  <!-- ===================================================
       部署ヘッダー - ①認：入口
  =================================================== -->
  <header class="department-header">
    <h1 class="department-title">企画</h1>
    <div class="header-actions">
      <button class="btn-hoshitori-table" id="btnOpenHoshitori">
        星取管理表
      </button>
      <button class="btn-hoshitori" id="btnOpenDashboard">
        進捗管理表
      </button>
      <button class="btn-worklog" id="btnOpenWorklog">作業完了ログ</button>
      <button class="btn-login" id="btnLogin">
        ログイン
      </button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="main-content">
    <!-- 絶期限・乱期限ハイライト表示 -->
    <section id="mainHighlights" class="main-highlights">
      <div class="loading" role="status" aria-live="polite" aria-busy="true">
        <div class="loading-spinner" aria-hidden="true"></div>
        <p>読み込み中...</p>
      </div>
    </section>
  </main>

  <!-- ===================================================
       ダッシュボードモーダル - ①認：モーダル表示
  =================================================== -->
  <div class="modal-overlay" id="dashboardModal">
    <div class="modal-container" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle" tabindex="-1">
      <header class="modal-header">
        <h2 class="modal-title" id="dashboardTitle">星取進捗ダッシュボード</h2>
        <button type="button" class="modal-close" id="btnCloseDashboard" aria-label="閉じる">×</button>
      </header>

      <div class="modal-body" id="dashboardContent">
        <div class="loading" role="status" aria-live="polite" aria-busy="true">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p>読み込み中...</p>
        </div>
      </div>

      <footer class="modal-footer">
        <span id="lastUpdated">最終更新: --</span>
        <span style="margin: 0 8px;">|</span>
        <span id="userStatus">閲覧モード</span>
      </footer>
    </div>
  </div>

  <!-- ===================================================
       星取管理表モーダル - 業務担当一覧表
  =================================================== -->
  <div class="hoshitori-modal" id="hoshitoriModal">
    <div class="hoshitori-container" role="dialog" aria-modal="true" aria-labelledby="hoshitoriTitle" tabindex="-1">
      <header class="hoshitori-header">
        <h2 class="hoshitori-title" id="hoshitoriTitle">星取管理表（業務担当一覧）</h2>
        <button type="button" class="modal-close" id="btnCloseHoshitori" aria-label="閉じる">×</button>
      </header>

      <div class="hoshitori-body">
        <div class="hoshitori-table-wrapper" id="hoshitoriTableWrapper">
          <div class="hoshitori-loading" role="status" aria-live="polite" aria-busy="true">
            <div class="loading-spinner" aria-hidden="true"></div>
            <p>読み込み中...</p>
          </div>
        </div>

        <div class="admin-panel" id="hoshitoriAdminPanel"></div>

        <div class="operation-log" id="hoshitoriLogContainer"></div>
      </div>

      <footer class="hoshitori-footer">
        <span id="hoshitoriLastUpdated">最終更新: --</span>
        <span id="hoshitoriUserStatus">閲覧モード</span>
      </footer>
    </div>
  </div>

  <!-- ===================================================
       作業完了ログモーダル
  =================================================== -->
  <div class="worklog-modal" id="worklogModal">
    <div class="worklog-container" role="dialog" aria-modal="true" aria-labelledby="worklogTitle" tabindex="-1">
      <header class="worklog-header">
        <h2 class="worklog-title" id="worklogTitle">作業完了ログ</h2>
        <button type="button" class="modal-close" id="btnCloseWorklog" aria-label="閉じる">×</button>
      </header>
      <div class="worklog-body">
        <table class="worklog-table">
          <thead>
            <tr><th style="width:220px;">完了日時</th><th>タスク名</th><th style="width:200px;">記録者</th></tr>
          </thead>
          <tbody id="worklogBody">
            <tr><td colspan="3" class="login-error" style="text-align:center;">読み込み中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ===================================================
       ログインモーダル - ⑥許：認証
  =================================================== -->
  <div class="login-modal" id="loginModal">
    <div class="login-container" role="dialog" aria-modal="true" aria-labelledby="loginTitle" tabindex="-1" style="position: relative;">
      <button type="button" class="login-close" id="btnCloseLogin" aria-label="閉じる">×</button>
      <h2 class="login-title" id="loginTitle">管理者ログイン</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">メールアドレス</label>
          <input type="email" class="form-input" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">パスワード</label>
          <input type="password" class="form-input" id="loginPassword" required>
        </div>
        <button type="submit" class="btn-submit" id="btnSubmitLogin">ログイン</button>
        <p class="login-error" id="loginError">ログインに失敗しました</p>
      </form>
    </div>
  </div>

  <!-- ===================================================
       add: new-task modal with date picker
  =================================================== -->
  <div class="login-modal" id="newTaskModal">
    <div class="login-container" role="dialog" aria-modal="true" aria-labelledby="newTaskModalTitle" tabindex="-1" style="position: relative;">
      <button type="button" class="login-close" id="btnCloseNewTask" aria-label="閉じる">×</button>
      <h2 class="login-title" id="newTaskModalTitle">新しいタスクを追加</h2>
      <form id="newTaskForm">
        <div class="form-group">
          <label class="form-label">タスク名（必須）</label>
          <input type="text" class="form-input" id="newTaskTitle" required>
        </div>
        <div class="form-group">
          <label class="form-label">期限（任意）</label>
          <input type="date" class="form-input" id="newTaskDeadline">
        </div>
        <p class="login-error" id="newTaskError" style="display:none;"></p>
        <button type="submit" class="btn-submit" id="btnSubmitNewTask">追加する</button>
      </form>
    </div>
  </div>

  <!-- ===================================================
       Firebase SDK & アプリケーションロジック
       ⑤幅：Firebase無料枠、Vanilla JS
  =================================================== -->
  <script type="module">
    // ===================================================
    // Firebase設定 - 単一HTMLに直書き（元: src/firebase/firebase-config.js）
    // ===================================================
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyC1cVgoBleKcvXU3Z1G0FNY8JlL72pNP-c",
      authDomain: "kikakugyoumu-907d6.firebaseapp.com",
      projectId: "kikakugyoumu-907d6",
      storageBucket: "kikakugyoumu-907d6.firebasestorage.app",
      messagingSenderId: "259870871782",
      appId: "1:259870871782:web:6cad7ff451d8cb5fdd6b27"
    };

    // ===================================================
    // 分類閾値定数 - 新ルール（期限日数ベース）に移行済み
    // 絶: 5日以内 かつ 進捗≤70%
    // 乱: 15日以内 かつ 進捗≤30%
    // 循: 上記以外
    // ===================================================
    // （旧THRESHOLDは不要のため削除）

    // ===================================================
    // 管理者メールアドレス - ⑥許：管理者1名のみ編集可
    // ===================================================
    const ADMIN_EMAIL = "shiozaki@newcom07.jp";

    // ===================================================
    // Firebase SDK 動的インポート
    // ===================================================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      orderBy,
      limit
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ===================================================
    // アプリケーション状態
    // ===================================================
    let app, auth, db;
    let currentUser = null;
    let isAdmin = false;
    let tasks = [];

    // ===================================================
    // ユーティリティ - completed型ブレ正規化
    // ===================================================
    function toBool(v) {
      if (v === true) return true;
      if (v === false) return false;
      if (typeof v === 'string') return v.toLowerCase() === 'true';
      if (typeof v === 'number') return v === 1;
      return false;
    }

    // ===================================================
    // DOM要素
    // ===================================================
    const elements = {
      btnOpenDashboard: document.getElementById('btnOpenDashboard'),
      btnCloseDashboard: document.getElementById('btnCloseDashboard'),
      dashboardModal: document.getElementById('dashboardModal'),
      dashboardContent: document.getElementById('dashboardContent'),
      btnOpenWorklog: document.getElementById('btnOpenWorklog'),
      btnCloseWorklog: document.getElementById('btnCloseWorklog'),
      worklogModal: document.getElementById('worklogModal'),
      worklogBody: document.getElementById('worklogBody'),
      btnLogin: document.getElementById('btnLogin'),
      btnCloseLogin: document.getElementById('btnCloseLogin'),
      loginModal: document.getElementById('loginModal'),
      loginForm: document.getElementById('loginForm'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginError: document.getElementById('loginError'),
      btnSubmitLogin: document.getElementById('btnSubmitLogin'),
      lastUpdated: document.getElementById('lastUpdated'),
      userStatus: document.getElementById('userStatus'),
      mainHighlights: document.getElementById('mainHighlights'),
      // add: new-task modal elements
      newTaskModal: document.getElementById('newTaskModal'),
      newTaskForm: document.getElementById('newTaskForm'),
      newTaskTitle: document.getElementById('newTaskTitle'),
      newTaskDeadline: document.getElementById('newTaskDeadline'),
      newTaskError: document.getElementById('newTaskError'),
      btnCloseNewTask: document.getElementById('btnCloseNewTask'),
      btnSubmitNewTask: document.getElementById('btnSubmitNewTask')
    };

    // ===================================================
    // 初期化
    // ===================================================
    function initFirebase() {
      try {
        app = initializeApp(FIREBASE_CONFIG);
        auth = getAuth(app);
        db = getFirestore(app);

        // 認証状態監視 - ⑥許：権限管理
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          isAdmin = user && user.email === ADMIN_EMAIL;
          updateAuthUI();
          renderMainHighlights();
          if (elements.dashboardModal.classList.contains('active')) {
            renderDashboard();
          }
        });

        console.log('Firebase initialized');
        renderMainHighlights();
        // fix: delegation for complete/delete - 初期化時に一度だけ親要素にバインド
        setupDelegatedEventListeners();
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }
    }

    // ===================================================
    // 認証UI更新 - ⑥許
    // ===================================================
    function updateAuthUI() {
      const btn = elements.btnLogin;
      if (currentUser) {
        btn.textContent = 'ログアウト';
        btn.classList.add('logged-in');
        elements.userStatus.textContent = isAdmin ? '管理者モード' : '閲覧モード';
      } else {
        btn.textContent = 'ログイン';
        btn.classList.remove('logged-in');
        elements.userStatus.textContent = '閲覧モード';
      }

      // 管理者モードクラス切り替え
      document.body.classList.toggle('admin-mode', isAdmin);
    }

    // ===================================================
    // タスク並び替え用比較関数 - priority → manualOrder → deadline
    // ===================================================
    function orderKey(t) {
      return (typeof t.manualOrder === 'number') ? t.manualOrder : Number.MAX_SAFE_INTEGER;
    }

    function compareTasks(a, b) {
      // 1. priority降順（3=最重要が先頭）
      const pa = typeof a.priority === 'number' ? a.priority : 0;
      const pb = typeof b.priority === 'number' ? b.priority : 0;
      if (pa !== pb) return pb - pa; // 降順

      // 2. manualOrder昇順
      const oa = orderKey(a), ob = orderKey(b);
      if (oa !== ob) return oa - ob;

      // 3. deadline昇順
      if (a.deadline && b.deadline) return new Date(a.deadline) - new Date(b.deadline);
      if (a.deadline && !b.deadline) return -1;
      if (!a.deadline && b.deadline) return 1;
      return (a.title || '').localeCompare(b.title || '');
    }

    // ===================================================
    // 分類ロジック - ②理：期限ステータス判定
    // 新ルール（優先順位順）:
    //   絶: 残り5日以内 かつ 進捗≤70%
    //   乱: 残り5日以内 かつ 進捗≤85%（絶に該当しない）
    //   乱: 残り15日以内 かつ 進捗≤30%
    //   循: 上記以外
    // ===================================================
    function classifyTask(task) {
      // 期限なしタスクは分類しない - ③衡
      if (!task.deadline) return null;

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const deadline = new Date(task.deadline);
      deadline.setHours(0, 0, 0, 0);

      const msPerDay = 24 * 60 * 60 * 1000;
      let daysUntil = Math.ceil((deadline - today) / msPerDay);
      if (daysUntil < 0) daysUntil = 0; // 期限超過も「以内」に含める

      const progress = Number(task.progress) || 0;

      // 優先順位: 絶 → 乱（5日85%）→ 乱（15日30%）→ 循
      if (daysUntil <= 5 && progress <= 70) return 'zetsu';
      if (daysUntil <= 5 && progress <= 85) return 'ran';
      if (daysUntil <= 15 && progress <= 30) return 'ran';
      return 'jun';
    }

    // ===================================================
    // タスク取得 - ④縁：データ構造
    // ===================================================
    async function fetchTasks() {
      try {
        const q = query(collection(db, 'tasks'), orderBy('deadline'));
        const snapshot = await getDocs(q);
        tasks = snapshot.docs.map(docu => {
          const d = docu.data();
          // デバッグ: completed型ブレ確認（問題解決後は削除可）
          // console.log('task completed raw:', docu.id, d.title, d.completed, typeof d.completed);
          return {
            id: docu.id,
            ...d,
            completed: toBool(d.completed), // 型ブレ正規化
            manualOrder: typeof d.manualOrder === 'number' ? d.manualOrder : null,
            priority: typeof d.priority === 'number' ? d.priority : 0 // 0=普通, 1=優先, 2=重要, 3=最重要
          };
        });
        return tasks;
      } catch (error) {
        console.error('Error fetching tasks:', error);
        return [];
      }
    }

    // ===================================================
    // ダッシュボードレンダリング - ③衡・④縁
    // 画面上部：絶期限 → 乱期限（最優先で可視化）
    // その下：期限ありタスク一覧（循・乱混在、色で判別）
    // ===================================================
    async function renderDashboard(skipFetch = false) {
      elements.dashboardContent.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>読み込み中...</p>
        </div>
      `;

      if (!skipFetch) await fetchTasks();

      // 期限ありタスクのみフィルタ - ③衡：期限なしタスクは表示しない
      const tasksWithDeadline = tasks.filter(t => t.deadline);

      // 分類
      const zetsuTasks = [];
      const ranTasks = [];
      const junTasks = [];

      tasksWithDeadline.forEach(task => {
        const status = classifyTask(task);
        task.status = status;
        if (status === 'zetsu') zetsuTasks.push(task);
        else if (status === 'ran') ranTasks.push(task);
        else junTasks.push(task);
      });

      // 並び替え（manualOrder優先、次に期限が近い順）
      zetsuTasks.sort(compareTasks);
      ranTasks.sort(compareTasks);
      junTasks.sort(compareTasks);

      let html = '';

      // ③衡：画面上部に絶期限
      html += renderSection('緊急', 'zetsu', zetsuTasks, '残り5日以内かつ進捗70%以下');

      // ③衡：次に乱期限
      html += renderSection('注意', 'ran', ranTasks, '残り5日以内85%以下 または 残り15日以内30%以下');

      // ④縁：区切り線
      html += '<div class="section-divider"></div>';

      // ③衡：期限ありタスク一覧（全件、循・乱混在）
      html += `
        <div class="deadline-section">
          <div class="section-header">
            <h3 class="section-title">期限ありタスク一覧</h3>
            <span class="section-count">${tasksWithDeadline.length}件</span>
          </div>
          <div class="task-list">
            ${tasksWithDeadline.length === 0
              ? '<div class="task-list-empty">タスクがありません</div>'
              : tasksWithDeadline.map(t => renderTaskCard(t)).join('')
            }
          </div>
          ${isAdmin ? '<button class="btn-add-task" id="btnAddTask">+ 新しいタスクを追加</button>' : ''}
        </div>
      `;

      // fix: show tasks without deadline - 期限なしタスク一覧を追加
      const tasksWithoutDeadline = tasks.filter(t => !t.deadline);
      if (tasksWithoutDeadline.length > 0 || isAdmin) {
        html += `
          <div class="deadline-section">
            <div class="section-header">
              <h3 class="section-title">期限なしタスク一覧</h3>
              <span class="section-count">${tasksWithoutDeadline.length}件</span>
            </div>
            <p class="muted" style="margin: 0 0 12px; font-size: 13px;">期限が未設定のタスク</p>
            <div class="task-list">
              ${tasksWithoutDeadline.length === 0
                ? '<div class="task-list-empty">期限なしタスクはありません</div>'
                : tasksWithoutDeadline.map(t => renderTaskCard(t)).join('')
              }
            </div>
          </div>
        `;
      }

      elements.dashboardContent.innerHTML = html;
      elements.lastUpdated.textContent = `最終更新: ${new Date().toLocaleString('ja-JP')}`;

      // イベントリスナー設定
      setupEventListeners();
    }

    // ===================================================
    // メインハイライト表示 - 絶期限・乱期限・循期限を常時表示
    // ===================================================
    async function renderMainHighlights(skipFetch = false) {
      if (!elements.mainHighlights) return;

      try {
        if (!skipFetch) await fetchTasks();

        const tasksWithDeadline = tasks.filter(t => t.deadline);
        const tasksWithoutDeadline = tasks.filter(t => !t.deadline); // 期限なしタスク
        const zetsuTasks = [];
        const ranTasks = [];
        const junTasks = []; // add: 循期限

        tasksWithDeadline.forEach(task => {
          const status = classifyTask(task);
          task.status = status;
          if (status === 'zetsu') zetsuTasks.push(task);
          else if (status === 'ran') ranTasks.push(task);
          else if (status === 'jun') junTasks.push(task); // add: 循期限
        });

        // 期限なしタスクにはステータスを設定（表示用）
        tasksWithoutDeadline.forEach(task => {
          task.status = 'jun'; // 期限なしはjunスタイルを使用
        });

        // 並び替え（manualOrder優先、次に期限が近い順）
        zetsuTasks.sort(compareTasks);
        ranTasks.sort(compareTasks);
        junTasks.sort(compareTasks); // add: 循期限
        tasksWithoutDeadline.sort(compareTasks); // 期限なしも並び替え

        let html = '';

        // 絶・乱・循・期限なしがすべて0件の場合
        if (zetsuTasks.length === 0 && ranTasks.length === 0 && junTasks.length === 0 && tasksWithoutDeadline.length === 0) {
          html = `
            <div class="main-highlights-empty">
              <p>現在、タスクはありません</p>
              <p style="margin-top: 8px; font-size: 13px;">「進捗管理表」でタスクを追加できます</p>
            </div>
          `;
        } else {
      html += renderSection('緊急', 'zetsu', zetsuTasks, '残り5日以内かつ進捗70%以下');
      html += renderSection('注意', 'ran', ranTasks, '残り5日以内85%以下 または 残り15日以内30%以下');
      html += renderSection('順調', 'jun', junTasks, '進捗に対し期限に余裕'); // add: 循期限
      // 期限なしタスクセクション
      if (tasksWithoutDeadline.length > 0) {
        html += renderSection('期限なし', 'nodeadline', tasksWithoutDeadline, '期限が未設定のタスク');
      }
        }

        elements.mainHighlights.innerHTML = html;

        // 管理者モードクラス適用
        elements.mainHighlights.classList.toggle('admin-mode', isAdmin);

        // メイン領域のイベントリスナー設定（管理者編集用）
        setupMainHighlightsEventListeners();
      } catch (error) {
        console.error('renderMainHighlights error:', error);
        elements.mainHighlights.innerHTML = `
          <div class="main-highlights-empty">
            <p>データの読み込みに失敗しました</p>
          </div>
        `;
      }
    }

    // メインハイライト用イベントリスナー
    function setupMainHighlightsEventListeners() {
      if (!elements.mainHighlights) return;

      // 進捗スライダー
      elements.mainHighlights.querySelectorAll('.progress-slider').forEach(slider => {
        slider.addEventListener('input', (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          card.querySelector('.hp-bar-value').textContent = `${value}%`;

          const task = tasks.find(t => t.id === taskId);
          if (task) {
            task.progress = value;
            const newStatus = classifyTask(task);
            card.className = `task-card ${newStatus}`;
            e.target.className = `progress-slider ${newStatus}`;
          }
        });

        slider.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          await updateTask(taskId, { progress: value });
          await renderMainHighlights();
        });
      });

      // タイトル編集
      elements.mainHighlights.querySelectorAll('.task-title-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          await updateTask(taskId, { title: e.target.value });
          await renderMainHighlights();
        });
      });

      // 期限編集
      elements.mainHighlights.querySelectorAll('.task-deadline-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const deadline = e.target.value || null;
          await updateTask(taskId, { deadline });
          await renderMainHighlights();
        });
      });

      // fix: delegation for complete/delete - 個別バインドは setupDelegatedEventListeners() に統合
    }

    // ===================================================
    // セクションレンダリング - ④縁
    // ===================================================
    function renderSection(title, status, tasks, description) {
      const badgeText = status === 'nodeadline' ? 'NIN' : status.toUpperCase();
      return `
        <div class="deadline-section ${status}">
          <div class="section-header">
            <span class="section-badge ${status}">${badgeText}</span>
            <h3 class="section-title">${title}</h3>
            <span class="section-count">${tasks.length}件</span>
          </div>
          <div class="task-list">
            ${tasks.length === 0
              ? `<div class="task-list-empty">該当するタスクはありません</div>`
              : tasks.map(t => renderTaskCard(t)).join('')
            }
          </div>
        </div>
      `;
    }

    // ===================================================
    // タスクカードレンダリング - ②理：HPバー風ゲージ
    // ===================================================
    function renderTaskCard(task) {
      const status = task.status || 'jun';
      const progress = task.progress || 0;
      const completed = toBool(task.completed); // 型ブレ正規化（!!は禁止）
      const deadlineStr = task.deadline
        ? new Date(task.deadline).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })
        : '期限なし';

      // 残り日数計算
      let remainingText = '';
      let isOverdue = false;
      if (task.deadline) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const deadline = new Date(task.deadline);
        deadline.setHours(0, 0, 0, 0);
        const remainingDays = Math.ceil((deadline - today) / (24 * 60 * 60 * 1000));

        if (remainingDays < 0) {
          remainingText = `${Math.abs(remainingDays)}日超過`;
          isOverdue = true;
        } else if (remainingDays === 0) {
          remainingText = '本日期限';
        } else {
          remainingText = `残り${remainingDays}日`;
        }
      }

      // ⑥許：管理者のみ編集可能なUIを表示
      // ドラッグハンドルSVG（星取と同じ）
      const dragHandleSvg = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>`;

      // 優先度クラス
      const priority = typeof task.priority === 'number' ? task.priority : 0;
      const priorityClass = priority > 0 ? ` priority-${priority}` : '';
      // 優先度ボタンのアイコン
      const priorityIcons = ['⚪', '☆', '⭐', '🌈'];
      const priorityLabels = ['普通', '優先', '重要', '最重要'];

      if (isAdmin) {
        return `
          <div class="task-card ${status}${priorityClass}" data-id="${task.id}" data-priority="${priority}">
            <div class="task-header">
              <span class="drag-handle" data-drag-type="dash-task" title="並び替えハンドル" aria-label="並び替え">${dragHandleSvg}</span>
              <button type="button" class="btn-priority" data-action="toggle-priority" data-priority="${priority}" title="${priorityLabels[priority]}（クリックで変更）">${priorityIcons[priority]}</button>
              <input type="text" class="task-title-input" value="${escapeHtml(task.title)}" data-field="title">
              <input type="date" class="task-deadline-input" value="${task.deadline || ''}" data-field="deadline">
              <div class="task-actions">
                <button type="button" class="btn-icon" data-action="complete" title="完了" ${completed ? 'disabled' : ''}>✓</button>
                <button type="button" class="btn-icon delete" data-action="delete" title="削除">✕</button>
              </div>
            </div>
            <div class="hp-bar-container">
              <span class="hp-bar-label">HP</span>
              <input type="range" class="progress-slider ${status}" min="0" max="100" value="${progress}" data-field="progress">
              <span class="hp-bar-value">${progress}%</span>
            </div>
            <div class="task-remaining ${isOverdue ? 'overdue' : ''}">${remainingText}</div>
            ${completed ? '<div class="muted" style="margin-top:6px;font-size:12px;">完了済み</div>' : ''}
          </div>
        `;
      } else {
        // 閲覧モード：編集不可（優先度エフェクトは表示）
        return `
          <div class="task-card ${status}${priorityClass}" data-id="${task.id}" data-priority="${priority}">
            <div class="task-header">
              <span class="task-title">${escapeHtml(task.title)}</span>
              <span class="task-deadline">${deadlineStr}</span>
            </div>
            <div class="hp-bar-container">
              <span class="hp-bar-label">HP</span>
              <div class="hp-bar-wrapper">
                <div class="hp-bar-fill ${status}" style="width: ${progress}%"></div>
              </div>
              <span class="hp-bar-value">${progress}%</span>
            </div>
            <div class="task-remaining ${isOverdue ? 'overdue' : ''}">${remainingText}</div>
          </div>
        `;
      }
    }

    // ===================================================
    // イベントリスナー設定 - ⑥許：管理者のみ編集
    // ===================================================
    function setupEventListeners() {
      // 進捗スライダー（即時色・分類更新）
      document.querySelectorAll('.progress-slider').forEach(slider => {
        // input: リアルタイム更新（ドラッグ中）
        slider.addEventListener('input', (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);

          // 即時UI更新
          card.querySelector('.hp-bar-value').textContent = `${value}%`;

          // 分類再計算
          const task = tasks.find(t => t.id === taskId);
          if (task) {
            task.progress = value;
            const newStatus = classifyTask(task);

            // 色更新
            card.className = `task-card ${newStatus}`;
            e.target.className = `progress-slider ${newStatus}`;
          }
        });

        // change: ドラッグ終了時にFirebase更新
        slider.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          await updateTask(taskId, { progress: value });
          await renderMainHighlights();
        });
      });

      // タイトル編集
      document.querySelectorAll('.task-title-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          await updateTask(taskId, { title: e.target.value });
          await renderMainHighlights();
        });
      });

      // 期限編集
      document.querySelectorAll('.task-deadline-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const deadline = e.target.value || null;
          await updateTask(taskId, { deadline });
          // 分類が変わる可能性があるので再レンダリング
          renderDashboard();
          renderMainHighlights();
        });
      });

      // fix: delegation for complete/delete - 個別バインドは setupDelegatedEventListeners() に統合

      // add: タスク追加ボタン → モーダルを開く（prompt廃止）
      const btnAddTask = document.getElementById('btnAddTask');
      if (btnAddTask) {
        btnAddTask.addEventListener('click', () => {
          openNewTaskModal();
        });
      }

      // 管理者モード時のみダッシュボード並び替え有効化
      if (isAdmin) {
        enableDashboardSorting();
      }
    }

    // ===================================================
    // ダッシュボードタスク並び替え - Pointer Events + 長押し
    // ===================================================
    function enableDashboardSorting() {
      // 各.task-listに対して並び替えを有効化（冪等チェック）
      const taskLists = document.querySelectorAll('.deadline-section .task-list');
      taskLists.forEach(taskList => {
        // 既にセットアップ済みならスキップ
        if (taskList.dataset.sortingEnabled === 'true') return;
        taskList.dataset.sortingEnabled = 'true';

        let draggedCard = null;
        let longPressTimer = null;
        let isDragging = false;
        let originalOrder = [];

        const clearDropTargets = () => {
          taskList.querySelectorAll('.drop-target-above, .drop-target-below').forEach(el => {
            el.classList.remove('drop-target-above', 'drop-target-below');
          });
        };

        const getTargetCard = (y) => {
          const cards = [...taskList.querySelectorAll('.task-card')];
          for (const card of cards) {
            const rect = card.getBoundingClientRect();
            if (y >= rect.top && y <= rect.bottom) {
              return { card, position: y < rect.top + rect.height / 2 ? 'above' : 'below' };
            }
          }
          return null;
        };

        const cleanup = () => {
          if (draggedCard) draggedCard.classList.remove('dragging');
          clearDropTargets();
          draggedCard = null;
          isDragging = false;
          if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
        };

        const rollbackDOM = () => {
          // 元の順序に戻す
          originalOrder.forEach(id => {
            const card = taskList.querySelector(`.task-card[data-id="${id}"]`);
            if (card) taskList.appendChild(card);
          });
        };

        const finishDrag = async (targetInfo) => {
          if (!draggedCard || !targetInfo || draggedCard === targetInfo.card) {
            cleanup();
            return;
          }

          const cards = [...taskList.querySelectorAll('.task-card')];
          const fromIndex = cards.indexOf(draggedCard);
          let toIndex = cards.indexOf(targetInfo.card);
          if (targetInfo.position === 'below') toIndex++;
          if (fromIndex < toIndex) toIndex--;

          // 同じ位置なら何もしない
          if (fromIndex === toIndex) {
            cleanup();
            return;
          }

          // DOM並び替え
          cards.splice(fromIndex, 1);
          cards.splice(toIndex, 0, draggedCard);
          cards.forEach(c => taskList.appendChild(c));

          // 新しい順序でID配列を取得
          const idsInOrder = cards.map(c => c.dataset.id);

          cleanup();

          // Firestore永続化
          try {
            await persistTaskOrder(idsInOrder);
            // 成功時は再描画
            await renderDashboard();
            await renderMainHighlights();
          } catch (e) {
            console.error('並び替え永続化エラー:', e);
            showToast('並び替えの保存に失敗しました: ' + (e.code || e.message));
            // DOMロールバック
            rollbackDOM();
          }
        };

        // Pointer Events
        taskList.addEventListener('pointerdown', (e) => {
          const handle = e.target.closest('.drag-handle[data-drag-type="dash-task"]');
          if (!handle) return;
          const card = handle.closest('.task-card');
          if (!card) return;
          e.preventDefault();

          // 元の順序を保存
          originalOrder = [...taskList.querySelectorAll('.task-card')].map(c => c.dataset.id);

          const startDrag = () => {
            draggedCard = card;
            isDragging = true;
            card.classList.add('dragging');
            card.setPointerCapture(e.pointerId);
          };

          // Mobile: 長押し300ms, PC: 即時
          if (e.pointerType === 'touch') {
            longPressTimer = setTimeout(startDrag, 300);
          } else {
            startDrag();
          }
        });

        taskList.addEventListener('pointermove', (e) => {
          if (longPressTimer && e.pointerType === 'touch') {
            // 指が動いたらキャンセル
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          if (!isDragging || !draggedCard) return;
          e.preventDefault();
          clearDropTargets();
          const target = getTargetCard(e.clientY);
          if (target && target.card !== draggedCard) {
            target.card.classList.add(target.position === 'above' ? 'drop-target-above' : 'drop-target-below');
          }
        });

        taskList.addEventListener('pointerup', async (e) => {
          if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
          if (!isDragging || !draggedCard) return;
          const target = getTargetCard(e.clientY);
          await finishDrag(target);
        });

        taskList.addEventListener('pointercancel', () => {
          cleanup();
        });

        // キーボードサポート: Alt + ArrowUp/Down
        taskList.addEventListener('keydown', async (e) => {
          if (!e.altKey || (e.key !== 'ArrowUp' && e.key !== 'ArrowDown')) return;
          const card = e.target.closest('.task-card');
          if (!card) return;
          e.preventDefault();

          const cards = [...taskList.querySelectorAll('.task-card')];
          const index = cards.indexOf(card);
          const direction = e.key === 'ArrowUp' ? -1 : 1;
          const newIndex = index + direction;

          if (newIndex < 0 || newIndex >= cards.length) return;

          // 視覚フィードバック
          card.classList.add('dragging');
          setTimeout(() => card.classList.remove('dragging'), 300);

          // DOM並び替え
          originalOrder = cards.map(c => c.dataset.id);
          cards.splice(index, 1);
          cards.splice(newIndex, 0, card);
          cards.forEach(c => taskList.appendChild(c));

          const idsInOrder = cards.map(c => c.dataset.id);

          try {
            await persistTaskOrder(idsInOrder);
            await renderDashboard();
            await renderMainHighlights();
          } catch (err) {
            showToast('並び替えに失敗しました: ' + (err.code || err.message));
            rollbackDOM();
          }
        });
      });
    }

    // ===================================================
    // タスク並び順永続化 - Firestore writeBatch
    // ===================================================
    async function persistTaskOrder(idsInOrder) {
      const { writeBatch, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
      const batch = writeBatch(db);
      const now = new Date().toISOString();
      idsInOrder.forEach((id, idx) => {
        batch.update(doc(db, 'tasks', id), {
          manualOrder: (idx + 1) * 1000,
          updatedAt: now
        });
      });
      await batch.commit();
    }

    // add: 新規タスクモーダルを開く
    function openNewTaskModal() {
      elements.newTaskModal.classList.add('active');
      if (typeof onModalOpen === 'function') onModalOpen();
      // 今日以降のみ選択可
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      elements.newTaskDeadline.min = `${yyyy}-${mm}-${dd}`;
      // フォームリセット
      elements.newTaskTitle.value = '';
      elements.newTaskDeadline.value = '';
      elements.newTaskError.style.display = 'none';
      // フォーカス
      setTimeout(() => elements.newTaskTitle.focus(), 0);
    }

    // add: 新規タスクモーダルを閉じる
    function closeNewTaskModal() {
      if (elements.newTaskModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
      elements.newTaskModal.classList.remove('active');
      elements.newTaskError.style.display = 'none';
    }

    // ===================================================
    // 日付バリデーション
    // ===================================================
    function isValidDate(dateString) {
      const regex = /^\d{4}-\d{2}-\d{2}$/;
      if (!regex.test(dateString)) return false;
      const date = new Date(dateString);
      return date instanceof Date && !isNaN(date);
    }

    // ===================================================
    // fix: delegation for complete/delete - イベントデリゲーション
    // 親要素で一括バインドし、再描画後も動作を保証
    // ===================================================
    function setupDelegatedEventListeners() {
      // dashboardContent へのデリゲーション
      if (elements.dashboardContent) {
        elements.dashboardContent.addEventListener('click', handleActionClick);
      }
      // mainHighlights へのデリゲーション
      if (elements.mainHighlights) {
        elements.mainHighlights.addEventListener('click', handleActionClick);
      }
    }

    // 完了・削除ボタンの共通ハンドラ
    async function handleActionClick(e) {
      const actionBtn = e.target.closest('[data-action]');
      if (!actionBtn) return;

      const action = actionBtn.dataset.action;
      const card = actionBtn.closest('.task-card');
      if (!card) return;

      const taskId = card.dataset.id;
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      if (action === 'complete') {
        // 既に完了済み or disabled なら何もしない (idempotent)
        if (toBool(task.completed) || actionBtn.disabled) return;

        const confirmed = await confirmDialog('completeTask', {
          title: '完了登録',
          message: `「${task.title || '(無題)'}」を完了登録しますか？`
        });
        if (!confirmed) return;

        actionBtn.disabled = true;
        try {
          await completeTaskAndLog(taskId, task.title);
          // tasksキャッシュを更新
          task.completed = true;
          // UI再描画
          await renderDashboard();
          await renderMainHighlights();
          // 作業完了ログモーダルが開いていれば更新
          if (elements.worklogModal && elements.worklogModal.classList.contains('active')) {
            await renderWorklog();
          }
        } catch (error) {
          console.error('Complete error:', error);
          showToast('完了登録に失敗しました: ' + (error.code || error.message));
          actionBtn.disabled = false;
        }
      } else if (action === 'delete') {
        const confirmed = await confirmDialog('deleteTask', {
          title: 'タスク削除',
          message: 'このタスクを削除しますか？',
          danger: true
        });
        if (!confirmed) return;

        actionBtn.disabled = true;
        try {
          await deleteTask(taskId);
          await renderDashboard();
          await renderMainHighlights();
        } catch (error) {
          console.error('Delete error:', error);
          showToast('削除に失敗しました: ' + (error.code || error.message));
          actionBtn.disabled = false;
        }
      } else if (action === 'toggle-priority') {
        // 優先度サイクル: 0 → 1 → 2 → 3 → 0
        const currentPriority = typeof task.priority === 'number' ? task.priority : 0;
        const newPriority = (currentPriority + 1) % 4;
        const priorityLabels = ['普通', '優先', '重要', '最重要'];

        try {
          await updateTask(taskId, { priority: newPriority });
          // Firestoreから最新データを1回だけ取得し、その後はキャッシュを使用
          await fetchTasks();
          showToast(`「${task.title || '(無題)'}」を${priorityLabels[newPriority]}に設定`);
          await renderDashboard(true);  // skipFetch=true: キャッシュ使用
          await renderMainHighlights(true);  // skipFetch=true: キャッシュ使用
        } catch (error) {
          console.error('Priority update error:', error);
          showToast('優先度の更新に失敗しました: ' + (error.code || error.message));
        }
      }
    }

    // ===================================================
    // タスク完了 + 作業完了ログ記録
    // ===================================================
    function formatDisplayDate(d = new Date()) {
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function completeTaskAndLog(taskId, taskName) {
      try {
        const when = new Date();
        await updateDoc(doc(db, 'tasks', taskId), {
          completed: true,
          completedAt: when.toISOString(),
          updatedAt: when.toISOString()
        });
        await addDoc(collection(db, 'work_logs'), {
          taskId,
          taskName: taskName || '(無題)',
          completedAt: when.toISOString(),
          completedAtDisplay: formatDisplayDate(when),
          completedAtEpoch: when.getTime(),
          user: currentUser?.email || 'unknown'
        });
      } catch (error) {
        console.error('Error completing task and logging:', error);
        throw error;
      }
    }

    // 作業完了ログの描画
    async function renderWorklog() {
      try {
        if (!elements.worklogBody) return;
        elements.worklogBody.innerHTML = `<tr><td colspan="3" class="login-error" style="text-align:center;">読み込み中...</td></tr>`;
        const q = query(collection(db, 'work_logs'), orderBy('completedAtEpoch', 'desc'), limit(200));
        const snapshot = await getDocs(q);
        const rows = snapshot.docs.map(docu => docu.data());
        if (rows.length === 0) {
          elements.worklogBody.innerHTML = `<tr><td colspan="3" class="login-error" style="text-align:center;">ログはまだありません</td></tr>`;
          return;
        }
        const html = rows.map(r => `
          <tr>
            <td>${escapeHtml(r.completedAtDisplay || (r.completedAt ? new Date(r.completedAt).toLocaleString('ja-JP') : '-'))}</td>
            <td>${escapeHtml(r.taskName || '(無題)')}</td>
            <td>${escapeHtml(r.user || '-')}</td>
          </tr>
        `).join('');
        elements.worklogBody.innerHTML = html;
      } catch (error) {
        console.error('Error rendering worklog:', error);
        if (elements.worklogBody) elements.worklogBody.innerHTML = `<tr><td colspan="3" class="login-error" style="text-align:center;">読み込みに失敗しました</td></tr>`;
      }
    }

    // ===================================================
    // タスクCRUD操作 - ⑥許
    // ===================================================
    function getFirestoreErrorMessage(error) {
      const code = error.code || '';
      if (code === 'permission-denied') {
        return '権限がありません。Firestoreルールで書き込みが許可されていません';
      } else if (code === 'failed-precondition') {
        return '前提条件エラー。Firestoreが未初期化/無効な操作の可能性';
      } else if (code === 'unavailable' || code === 'network-request-failed') {
        return 'ネットワークまたはサービス一時障害';
      } else if (code === 'unauthenticated') {
        return '認証されていません。ログインしてください';
      } else if (code === 'not-found') {
        return '対象のドキュメントが見つかりません';
      }
      return '予期しないエラーが発生しました';
    }

    async function addTask(taskData) {
      try {
        await addDoc(collection(db, 'tasks'), taskData);
      } catch (error) {
        console.error('Error adding task:', error);
        const msg = getFirestoreErrorMessage(error);
        showToast('タスクの追加に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    async function updateTask(taskId, updates) {
      try {
        await updateDoc(doc(db, 'tasks', taskId), updates);
      } catch (error) {
        console.error('Error updating task:', error);
        const msg = getFirestoreErrorMessage(error);
        showToast('タスクの更新に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    async function deleteTask(taskId) {
      try {
        await deleteDoc(doc(db, 'tasks', taskId));
      } catch (error) {
        console.error('Error deleting task:', error);
        const msg = getFirestoreErrorMessage(error);
        showToast('タスクの削除に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    // ===================================================
    // 初期データ投入 - ⑦循：運用のための初期データ
    // ===================================================
    async function seedInitialData() {
      try {
        const snapshot = await getDocs(collection(db, 'tasks'));
        if (snapshot.empty) {
          const today = new Date();
          const initialTasks = [
            {
              title: '四半期レポート作成',
              progress: 30,
              deadline: getDateString(7),
              createdAt: getDateString(-14)
            },
            {
              title: 'クライアントA提案書',
              progress: 75,
              deadline: getDateString(14),
              createdAt: getDateString(-7)
            },
            {
              title: '新規営業リスト作成',
              progress: 10,
              deadline: getDateString(3),
              createdAt: getDateString(-10)
            },
            {
              title: '月次会議資料準備',
              progress: 90,
              deadline: getDateString(5),
              createdAt: getDateString(-3)
            },
            {
              title: '顧客満足度調査',
              progress: 50,
              deadline: getDateString(21),
              createdAt: getDateString(-5)
            }
          ];

          for (const task of initialTasks) {
            await addDoc(collection(db, 'tasks'), task);
          }
          console.log('Initial data seeded');
          await renderMainHighlights();
        }
      } catch (error) {
        console.error('Error seeding data:', error);
        const msg = getFirestoreErrorMessage(error);
        showToast('初期データ投入に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    function getDateString(daysFromNow) {
      const date = new Date();
      date.setDate(date.getDate() + daysFromNow);
      return date.toISOString().split('T')[0];
    }

    // ===================================================
    // ユーティリティ - ⑨絶：XSS対策
    // ===================================================
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ===================================================
    // モーダル制御 - ①認：入口
    // ===================================================
    elements.btnOpenDashboard.addEventListener('click', () => {
      elements.dashboardModal.classList.add('active');
      if (typeof onModalOpen === 'function') onModalOpen();
      renderDashboard();
    });

    elements.btnCloseDashboard.addEventListener('click', () => {
      if (elements.dashboardModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
      elements.dashboardModal.classList.remove('active');
    });

    elements.dashboardModal.addEventListener('click', (e) => {
      if (e.target === elements.dashboardModal) {
        if (elements.dashboardModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
        elements.dashboardModal.classList.remove('active');
      }
    });

    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        const wasAnyActive = [elements.dashboardModal, elements.loginModal, elements.worklogModal, elements.newTaskModal]
          .some(m => m && m.classList.contains('active'));
        elements.dashboardModal.classList.remove('active');
        elements.loginModal.classList.remove('active');
        elements.worklogModal.classList.remove('active');
        closeNewTaskModal();  // add: new-task modal
        if (wasAnyActive && typeof onModalClose === 'function') onModalClose();
      }
    });

    // add: 新規タスクモーダル - 閉じるボタン
    elements.btnCloseNewTask?.addEventListener('click', closeNewTaskModal);

    // add: 新規タスクモーダル - 背景クリックで閉じる
    elements.newTaskModal?.addEventListener('click', (e) => {
      if (e.target === elements.newTaskModal) {
        closeNewTaskModal();
      }
    });

    // add: 新規タスクモーダル - フォーム送信
    elements.newTaskForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      elements.btnSubmitNewTask.disabled = true;
      elements.newTaskError.style.display = 'none';

      try {
        const title = elements.newTaskTitle.value.trim();
        if (!title) {
          throw { code: 'invalid-title' };
        }
        const dl = elements.newTaskDeadline.value; // '' or 'YYYY-MM-DD'

        await addTask({
          title,
          progress: 0,
          deadline: dl || null,
          createdAt: new Date().toISOString(),
          completed: false
        });

        closeNewTaskModal();
        elements.newTaskForm.reset();
        await renderDashboard();
        await renderMainHighlights();
      } catch (error) {
        const code = error.code || '';
        let msg = '追加に失敗しました';
        if (code === 'invalid-title') msg = 'タスク名を入力してください';
        else if (code === 'permission-denied') msg = '権限がありません';
        elements.newTaskError.textContent = `${msg} ${code ? '(' + code + ')' : ''}`;
        elements.newTaskError.style.display = 'block';
      } finally {
        elements.btnSubmitNewTask.disabled = false;
      }
    });

    // ===================================================
    // ログイン制御 - ⑥許：認証
    // ===================================================
    elements.btnLogin.addEventListener('click', () => {
      if (currentUser) {
        signOut(auth);
      } else {
        elements.loginModal.classList.add('active'); if (typeof onModalOpen === 'function') onModalOpen();
      }
    });

    // 作業完了ログ モーダル開閉
    if (elements.btnOpenWorklog) {
      elements.btnOpenWorklog.addEventListener('click', async () => {
        elements.worklogModal.classList.add('active'); if (typeof onModalOpen === 'function') onModalOpen();
        await renderWorklog();
      });
    }
    if (elements.btnCloseWorklog) {
      elements.btnCloseWorklog.addEventListener('click', () => {
        if (elements.worklogModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
        elements.worklogModal.classList.remove('active');
      });
    }
    if (elements.worklogModal) {
      elements.worklogModal.addEventListener('click', (e) => {
        if (e.target === elements.worklogModal) {
          if (elements.worklogModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
          elements.worklogModal.classList.remove('active');
        }
      });
    }

    elements.btnCloseLogin.addEventListener('click', () => {
      if (elements.loginModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
      elements.loginModal.classList.remove('active');
      elements.loginError.classList.remove('show');
    });

    elements.loginModal.addEventListener('click', (e) => {
      if (e.target === elements.loginModal) {
        if (elements.loginModal.classList.contains('active') && typeof onModalClose === 'function') onModalClose();
        elements.loginModal.classList.remove('active');
        elements.loginError.classList.remove('show');
      }
    });

    elements.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      elements.btnSubmitLogin.disabled = true;
      elements.loginError.classList.remove('show');

      try {
        await signInWithEmailAndPassword(
          auth,
          elements.loginEmail.value,
          elements.loginPassword.value
        );
        elements.loginModal.classList.remove('active');
        elements.loginForm.reset();
      } catch (error) {
        console.error('Login error:', error);
        let errorMessage = 'ログインに失敗しました';
        if (error.code === 'auth/invalid-api-key') {
          errorMessage = 'Firebase設定(APIキー)が不正です';
        } else if (error.code === 'auth/operation-not-supported-in-this-environment') {
          errorMessage = 'この環境では実行できません。HTTPサーバで配信してください';
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMessage = '許可されていないドメインです。Firebaseの許可ドメインに追加してください';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'ネットワークエラーが発生しました';
        } else if (error.code === 'auth/user-not-found') {
          errorMessage = 'ユーザーが見つかりません';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'パスワードが正しくありません';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'メールアドレスの形式が正しくありません';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = '認証情報が無効です';
        }
        elements.loginError.textContent = errorMessage + ' (' + error.code + ')';
        elements.loginError.classList.add('show');
      } finally {
        elements.btnSubmitLogin.disabled = false;
      }
    });

    // ===================================================
    // アプリケーション起動
    // ===================================================
    initFirebase();

    // 初期データ投入（Firebase接続確認後、管理者のみ実行）
    setTimeout(() => {
      if (db && isAdmin) {
        seedInitialData();
      }
    }, 2000);

    // ===================================================
    // 星取管理表モジュール（inlined from src/hoshitori/hoshitori.js）
    // ===================================================
    const MEMBERS = { meguro: '目黒', umemoto: '梅本', niidome: '新留', shiozaki: '塩崎' };
    const MEMBER_KEYS = ['meguro', 'umemoto', 'niidome', 'shiozaki'];

    const PROJECT_ID = 'project_2026'; // project scope対応

    class HoshitoriManager {
      constructor(db, auth, adminEmail) {
        this.db = db; this.auth = auth; this.adminEmail = adminEmail;
        this.categories = []; this.isAdmin = false; this.currentUser = null; this.unsubscribe = null;
      }
      checkIsAdmin() {
        this.currentUser = this.auth.currentUser;
        this.isAdmin = this.currentUser && this.currentUser.email === this.adminEmail;
        return this.isAdmin;
      }
      async subscribeToData(onUpdate) {
        const { collection, query, orderBy, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const q = query(
          collection(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori'), // project scope対応
          orderBy('order')
        );
        this.unsubscribe = onSnapshot(q, (snapshot) => {
          this.categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          onUpdate(this.categories);
        }, (error) => { console.error('Hoshitori subscription error:', error); });
      }
      unsubscribeFromData() { if (this.unsubscribe) { this.unsubscribe(); this.unsubscribe = null; } }
      async addCategory(title) {
        if (!this.isAdmin) return false;
        const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const maxOrder = this.categories.reduce((m, c) => Math.max(m, c.order || 0), 0);
          await addDoc(
            collection(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori'), // project scope対応
            { title, order: maxOrder + 1, tasks: [], createdAt: new Date().toISOString(), createdBy: this.currentUser.email }
          );
          await this.logOperation('ADD_CATEGORY', { title });
          return true;
        } catch (e) { console.error('Error adding category:', e); throw e; }
      }
      async updateCategoryTitle(categoryId, newTitle) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId), // project scope対応
            { title: newTitle, updatedAt: new Date().toISOString() }
          );
          await this.logOperation('UPDATE_CATEGORY', { categoryId, newTitle });
          return true;
        }
        catch (e) { console.error('Error updating category:', e); throw e; }
      }
      async deleteCategory(categoryId) {
        if (!this.isAdmin) return false;
        const { doc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const category = this.categories.find(c => c.id === categoryId);
          await deleteDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId) // project scope対応
          );
          await this.logOperation('DELETE_CATEGORY', { categoryId, title: category?.title });
          return true;
        }
        catch (e) { console.error('Error deleting category:', e); throw e; }
      }
      async addTask(categoryId, taskName) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc, arrayUnion } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const newTask = { id: Date.now().toString(), name: taskName, owners: { meguro: false, umemoto: false, niidome: false, shiozaki: false }, createdAt: new Date().toISOString() };
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId), // project scope対応
            { tasks: arrayUnion(newTask) }
          );
          await this.logOperation('ADD_TASK', { categoryId, taskName });
          return true;
        } catch (e) { console.error('Error adding task:', e); throw e; }
      }
      async updateTaskName(categoryId, taskId, newName) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const category = this.categories.find(c => c.id === categoryId); if (!category) return false;
          const tasks = (category.tasks || []).map(t => t.id === taskId ? { ...t, name: newName } : t);
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId), // project scope対応
            { tasks }
          );
          await this.logOperation('UPDATE_TASK', { categoryId, taskId, newName });
          return true;
        } catch (e) { console.error('Error updating task:', e); throw e; }
      }
      async deleteTask(categoryId, taskId) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const category = this.categories.find(c => c.id === categoryId); if (!category) return false;
          const task = (category.tasks || []).find(t => t.id === taskId);
          const tasks = (category.tasks || []).filter(t => t.id !== taskId);
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId), // project scope対応
            { tasks }
          );
          await this.logOperation('DELETE_TASK', { categoryId, taskId, taskName: task?.name });
          return true;
        } catch (e) { console.error('Error deleting task:', e); throw e; }
      }
      async toggleOwner(categoryId, taskId, memberKey) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const category = this.categories.find(c => c.id === categoryId); if (!category) return false;
          const tasks = (category.tasks || []).map(t => {
            if (t.id === taskId) { const newValue = !t.owners[memberKey]; return { ...t, owners: { ...t.owners, [memberKey]: newValue } }; }
            return t; });
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId), // project scope対応
            { tasks }
          );
          const task = (category.tasks || []).find(t => t.id === taskId); const newValue = !task.owners[memberKey];
          await this.logOperation('TOGGLE_OWNER', { categoryId, taskId, taskName: task?.name, member: MEMBERS[memberKey], value: newValue ? '○' : '空' });
          return true;
        } catch (e) { console.error('Error toggling owner:', e); throw e; }
      }
      async logOperation(action, details) {
        const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try { await addDoc(collection(this.db, 'hoshitori_logs'), { action, details, user: this.currentUser?.email || 'unknown', timestamp: new Date().toISOString() }); }
        catch (e) { console.error('Error logging operation:', e); }
      }
      async getRecentLogs(limitN = 10) {
        const { collection, query, orderBy, limit: limitFn, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try { const q = query(collection(this.db, 'hoshitori_logs'), orderBy('timestamp', 'desc'), limitFn(limitN)); const snapshot = await getDocs(q); return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); }
        catch (e) { console.error('Error getting logs:', e); return []; }
      }
      async seedInitialData() {
        if (!this.isAdmin) return false;
        const { collection, getDocs, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const snapshot = await getDocs(
            collection(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori') // project scope対応
          );
          if (!snapshot.empty) { console.log('Hoshitori data already exists'); return false; }
          const initialData = [
            { title: '1.公開サイト', order: 1, tasks: [ { id: '1', name: 'ニューコム', owners: { meguro: false, umemoto: true, niidome: true, shiozaki: true } }, { id: '2', name: 'dbSheet', owners: { meguro: false, umemoto: true, niidome: false, shiozaki: true } } ] },
            { title: '2.ブログサイト', order: 2, tasks: [ { id: '3', name: 'テックブログ', owners: { meguro: true, umemoto: false, niidome: true, shiozaki: false } }, { id: '4', name: '社内報', owners: { meguro: false, umemoto: true, niidome: false, shiozaki: true } } ] },
            { title: '3.社内システム', order: 3, tasks: [ { id: '5', name: '勤怠管理', owners: { meguro: true, umemoto: true, niidome: false, shiozaki: false } }, { id: '6', name: '経費精算', owners: { meguro: false, umemoto: false, niidome: true, shiozaki: true } } ] }
          ];
          for (const category of initialData) {
            await addDoc(
              collection(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori'), // project scope対応
              { ...category, createdAt: new Date().toISOString(), createdBy: this.currentUser.email }
            );
          }
          console.log('Hoshitori initial data seeded');
          return true;
        } catch (e) { console.error('Error seeding hoshitori data:', e); throw e; }
      }
      async reorderCategories(categoryIdsInOrder) {
        if (!this.isAdmin) return false;
        const { doc, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const batch = writeBatch(this.db);
          categoryIdsInOrder.forEach((id, index) => {
            const ref = doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', id);
            batch.update(ref, { order: index + 1, updatedAt: new Date().toISOString() });
          });
          await batch.commit();
          await this.logOperation('REORDER_CATEGORIES', { newOrder: categoryIdsInOrder });
          return true;
        } catch (e) { console.error('Error reordering categories:', e); throw e; }
      }
      async reorderTasks(categoryId, taskIdsInOrder) {
        if (!this.isAdmin) return false;
        const { doc, updateDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        try {
          const category = this.categories.find(c => c.id === categoryId);
          if (!category) return false;
          const taskMap = new Map((category.tasks || []).map(t => [t.id, t]));
          const reorderedTasks = taskIdsInOrder.map(id => taskMap.get(id)).filter(Boolean);
          await updateDoc(
            doc(this.db, 'hoshitori_projects', PROJECT_ID, 'hoshitori', categoryId),
            { tasks: reorderedTasks, updatedAt: new Date().toISOString() }
          );
          await this.logOperation('REORDER_TASKS', { categoryId, newOrder: taskIdsInOrder });
          return true;
        } catch (e) { console.error('Error reordering tasks:', e); throw e; }
      }
    }

    class HoshitoriUI {
      constructor(manager, elements) { this.manager = manager; this.elements = elements; this.editingCell = null; }
      render(categories) {
        const isAdmin = this.manager.isAdmin;
        if ((categories || []).length === 0) {
          this.elements.tableWrapper.innerHTML = `<div class="hoshitori-empty"><p>データがありません</p>${isAdmin ? '<p style="margin-top: 8px; font-size: 13px;">下部の管理者操作パネルから追加してください</p>' : ''}</div>`; return;
        }
        let html = `
          <table class="hoshitori-table">
            <thead>
              <tr>
                <th class="task-name-col">業務内容</th>
                ${MEMBER_KEYS.map(key => `<th class="member-col">${MEMBERS[key]}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
        `;
        const dragHandleSvg = `<svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm8-16a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0 8a2 2 0 1 1 0-4 2 2 0 0 1 0 4z"/></svg>`;
        categories.forEach(category => {
          html += `
            <tr class="category-row" data-category-id="${category.id}" tabindex="0">
              <td colspan="${MEMBER_KEYS.length + 1}" class="category-cell"><span class="drag-handle" data-drag-type="category">${dragHandleSvg}</span><span class="category-title">${this.escapeHtml(category.title)}</span></td>
            </tr>
          `;
          (category.tasks || []).forEach(task => {
            html += `
              <tr class="task-row" data-category-id="${category.id}" data-task-id="${task.id}" tabindex="0">
                <td class="task-name-cell"><span class="drag-handle" data-drag-type="task">${dragHandleSvg}</span><span class="task-name">${this.escapeHtml(task.name)}</span></td>
                ${MEMBER_KEYS.map(key => `
                  <td class="owner-cell ${isAdmin ? 'editable' : ''}" data-category-id="${category.id}" data-task-id="${task.id}" data-member="${key}">
                    <span class="owner-mark ${task.owners && task.owners[key] ? 'active' : ''}">${task.owners && task.owners[key] ? '○' : ''}</span>
                  </td>
                `).join('')}
              </tr>
            `;
          });
        });
        html += `</tbody></table>`;
        this.elements.tableWrapper.innerHTML = html;
        this.setupTableEventListeners();
        this.enableSorting();
      }
      setupTableEventListeners() {
        const table = this.elements.tableWrapper.querySelector('.hoshitori-table'); if (!table) return;
        table.querySelectorAll('.owner-cell.editable').forEach(cell => {
          cell.addEventListener('click', async () => {
            const categoryId = cell.dataset.categoryId; const taskId = cell.dataset.taskId; const memberKey = cell.dataset.member;
            const mark = cell.querySelector('.owner-mark'); const currentState = mark.classList.contains('active');
            mark.classList.toggle('active', !currentState); mark.textContent = currentState ? '' : '○';
            try { await this.manager.toggleOwner(categoryId, taskId, memberKey); }
            catch (e) { mark.classList.toggle('active', currentState); mark.textContent = currentState ? '○' : ''; this.showError('担当の変更に失敗しました: ' + (e.code || e.message)); }
          });
        });
      }
      enableSorting() {
        if (!this.manager.isAdmin) return;
        const table = this.elements.tableWrapper.querySelector('.hoshitori-table');
        if (!table) return;
        const tbody = table.querySelector('tbody');
        if (!tbody) return;

        let draggedRow = null;
        let dragType = null;
        let dragCategoryId = null;
        let longPressTimer = null;
        let isDragging = false;

        const clearDropTargets = () => {
          tbody.querySelectorAll('.drop-target-above, .drop-target-below').forEach(el => {
            el.classList.remove('drop-target-above', 'drop-target-below');
          });
        };

        const getTargetRow = (y, type, categoryId) => {
          const rows = type === 'category'
            ? [...tbody.querySelectorAll('.category-row')]
            : [...tbody.querySelectorAll(`.task-row[data-category-id="${categoryId}"]`)];
          for (const row of rows) {
            const rect = row.getBoundingClientRect();
            if (y >= rect.top && y <= rect.bottom) {
              return { row, position: y < rect.top + rect.height / 2 ? 'above' : 'below' };
            }
          }
          return null;
        };

        const finishDrag = async (targetRow, position) => {
          if (!draggedRow || !targetRow || draggedRow === targetRow.row) {
            cleanup();
            return;
          }
          try {
            if (dragType === 'category') {
              const rows = [...tbody.querySelectorAll('.category-row')];
              const fromIndex = rows.indexOf(draggedRow);
              let toIndex = rows.indexOf(targetRow.row);
              if (position === 'below') toIndex++;
              if (fromIndex < toIndex) toIndex--;
              rows.splice(fromIndex, 1);
              rows.splice(toIndex, 0, draggedRow);
              const newOrder = rows.map(r => r.dataset.categoryId);
              await this.manager.reorderCategories(newOrder);
            } else {
              const rows = [...tbody.querySelectorAll(`.task-row[data-category-id="${dragCategoryId}"]`)];
              const fromIndex = rows.indexOf(draggedRow);
              let toIndex = rows.indexOf(targetRow.row);
              if (position === 'below') toIndex++;
              if (fromIndex < toIndex) toIndex--;
              rows.splice(fromIndex, 1);
              rows.splice(toIndex, 0, draggedRow);
              const newOrder = rows.map(r => r.dataset.taskId);
              await this.manager.reorderTasks(dragCategoryId, newOrder);
            }
          } catch (e) {
            this.showError('並び替えに失敗しました: ' + (e.code || e.message));
          }
          cleanup();
        };

        const cleanup = () => {
          if (draggedRow) draggedRow.classList.remove('dragging');
          clearDropTargets();
          draggedRow = null;
          dragType = null;
          dragCategoryId = null;
          isDragging = false;
          if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
        };

        // Pointer events for drag handles
        tbody.addEventListener('pointerdown', (e) => {
          const handle = e.target.closest('.drag-handle');
          if (!handle) return;
          const row = handle.closest('tr');
          if (!row) return;
          e.preventDefault();
          dragType = handle.dataset.dragType;
          dragCategoryId = row.dataset.categoryId;

          const startDrag = () => {
            draggedRow = row;
            isDragging = true;
            row.classList.add('dragging');
            row.setPointerCapture(e.pointerId);
          };

          // Mobile: long press (300ms), PC: immediate
          if (e.pointerType === 'touch') {
            longPressTimer = setTimeout(startDrag, 300);
          } else {
            startDrag();
          }
        });

        tbody.addEventListener('pointermove', (e) => {
          if (longPressTimer && e.pointerType === 'touch') {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          if (!isDragging || !draggedRow) return;
          e.preventDefault();
          clearDropTargets();
          const target = getTargetRow(e.clientY, dragType, dragCategoryId);
          if (target && target.row !== draggedRow) {
            target.row.classList.add(target.position === 'above' ? 'drop-target-above' : 'drop-target-below');
          }
        });

        tbody.addEventListener('pointerup', async (e) => {
          if (longPressTimer) { clearTimeout(longPressTimer); longPressTimer = null; }
          if (!isDragging || !draggedRow) return;
          const target = getTargetRow(e.clientY, dragType, dragCategoryId);
          await finishDrag(target, target?.position);
        });

        tbody.addEventListener('pointercancel', cleanup);

        // Keyboard support: Alt + Arrow keys
        tbody.addEventListener('keydown', async (e) => {
          if (!e.altKey || (e.key !== 'ArrowUp' && e.key !== 'ArrowDown')) return;
          const row = e.target.closest('tr.category-row, tr.task-row');
          if (!row) return;
          e.preventDefault();

          const isCategory = row.classList.contains('category-row');
          const categoryId = row.dataset.categoryId;
          const direction = e.key === 'ArrowUp' ? -1 : 1;

          row.classList.add('reorder-focus');
          setTimeout(() => row.classList.remove('reorder-focus'), 300);

          try {
            if (isCategory) {
              const rows = [...tbody.querySelectorAll('.category-row')];
              const index = rows.indexOf(row);
              const newIndex = index + direction;
              if (newIndex < 0 || newIndex >= rows.length) return;
              rows.splice(index, 1);
              rows.splice(newIndex, 0, row);
              const newOrder = rows.map(r => r.dataset.categoryId);
              await this.manager.reorderCategories(newOrder);
            } else {
              const rows = [...tbody.querySelectorAll(`.task-row[data-category-id="${categoryId}"]`)];
              const index = rows.indexOf(row);
              const newIndex = index + direction;
              if (newIndex < 0 || newIndex >= rows.length) return;
              rows.splice(index, 1);
              rows.splice(newIndex, 0, row);
              const newOrder = rows.map(r => r.dataset.taskId);
              await this.manager.reorderTasks(categoryId, newOrder);
            }
          } catch (err) {
            this.showError('並び替えに失敗しました: ' + (err.code || err.message));
          }
        });
      }
      renderAdminPanel() {
        if (!this.manager.isAdmin) { this.elements.adminPanel.style.display = 'none'; return; }
        this.elements.adminPanel.style.display = 'block';
        this.elements.adminPanel.innerHTML = `
          <div class="admin-panel-title">管理者操作</div>
          <div class="admin-buttons">
            <button class="btn-admin" id="btnAddCategory">＋ 大項目追加</button>
            <button class="btn-admin" id="btnAddTaskGlobal">＋ タスク追加</button>
            <button class="btn-admin danger" id="btnManageData">データ管理</button>
            <button class="btn-admin" id="btnSeedData">初期データ投入</button>
            <button class="btn-admin" id="btnResetConfirmSettings">確認設定リセット</button>
          </div>
        `;
        document.getElementById('btnAddCategory')?.addEventListener('click', async () => {
          const title = await textInputDialog({ title: '大項目追加', label: '名称' });
          if (title && title.trim()) {
            try { await this.manager.addCategory(title.trim()); }
            catch (e) { this.showError('大項目の追加に失敗しました: ' + (e.code || e.message)); }
          }
        });
        document.getElementById('btnAddTaskGlobal')?.addEventListener('click', async () => {
          const categories = this.manager.categories;
          if (categories.length === 0) { showToast('先に大項目を追加してください'); return; }
          const selectedCategoryId = await selectDialog({
            title: '追加先の大項目を選択',
            items: categories.map((c, i) => ({ id: c.id, label: `${i + 1}: ${c.title}` }))
          });
          if (!selectedCategoryId) return;
          const taskName = await textInputDialog({ title: 'タスク追加', label: '名称' });
          if (taskName && taskName.trim()) {
            try { await this.manager.addTask(selectedCategoryId, taskName.trim()); }
            catch (e) { this.showError('タスクの追加に失敗しました: ' + (e.code || e.message)); }
          }
        });
        document.getElementById('btnManageData')?.addEventListener('click', () => { this.showDataManagementModal(); });
        document.getElementById('btnSeedData')?.addEventListener('click', async () => {
          const confirmed = await confirmDialog('seedHoshitoriData', {
            title: '初期データ投入',
            message: 'サンプルの初期データを投入しますか？\n（既にデータがある場合は投入されません）'
          });
          if (confirmed) {
            try {
              const result = await this.manager.seedInitialData();
              if (result) { showToast('初期データを投入しました'); }
              else { showToast('既にデータが存在するため、投入しませんでした'); }
            }
            catch (e) { this.showError('初期データの投入に失敗しました: ' + (e.code || e.message)); }
          }
        });
        document.getElementById('btnResetConfirmSettings')?.addEventListener('click', () => {
          resetConfirmSettings();
        });
        // Floating Admin Bar
        this.ensureFloatingAdminBar();
      }
      ensureFloatingAdminBar() {
        const modal = hoshitoriElements.modal;
        const existingFab = document.getElementById('adminFab');
        const existingMenu = document.getElementById('adminFabMenu');

        // Hide if not admin
        if (!this.manager.isAdmin) {
          if (existingFab) existingFab.style.display = 'none';
          if (existingMenu) { existingMenu.style.display = 'none'; existingMenu.classList.remove('open'); }
          return;
        }

        // Already exists - just show
        if (existingFab && existingMenu) {
          existingFab.style.display = '';
          return;
        }

        // Create FAB
        const fab = document.createElement('button');
        fab.id = 'adminFab';
        fab.className = 'admin-fab';
        fab.setAttribute('aria-label', '管理者操作');
        fab.setAttribute('title', '管理者操作 (G)');
        fab.textContent = '＋';

        // Create Menu
        const menu = document.createElement('div');
        menu.id = 'adminFabMenu';
        menu.className = 'admin-fab-menu';
        menu.setAttribute('role', 'menu');
        menu.innerHTML = `
          <div class="admin-fab-menu-title">管理者操作</div>
          <div class="admin-fab-actions">
            <button class="admin-fab-btn" id="fabAddCategory" role="menuitem">＋ 大項目追加<span class="admin-fab-shortcut">C</span></button>
            <button class="admin-fab-btn" id="fabAddTask" role="menuitem">＋ タスク追加<span class="admin-fab-shortcut">T</span></button>
            <button class="admin-fab-btn danger" id="fabDataManage" role="menuitem">データ管理<span class="admin-fab-shortcut">D</span></button>
            <button class="admin-fab-btn" id="fabSeedData" role="menuitem">初期データ投入<span class="admin-fab-shortcut">S</span></button>
            <button class="admin-fab-btn" id="fabResetConfirm" role="menuitem">確認設定リセット<span class="admin-fab-shortcut">R</span></button>
          </div>
        `;

        modal.appendChild(fab);
        modal.appendChild(menu);

        const self = this;
        const closeMenu = () => { menu.classList.remove('open'); fab.classList.remove('open'); };
        const toggleMenu = () => {
          const isOpen = menu.classList.toggle('open');
          fab.classList.toggle('open', isOpen);
          if (isOpen) document.getElementById('fabAddCategory')?.focus();
        };

        // FAB click
        fab.addEventListener('click', (e) => { e.stopPropagation(); toggleMenu(); });

        // Close on outside click
        modal.addEventListener('click', (e) => {
          if (!fab.contains(e.target) && !menu.contains(e.target)) closeMenu();
        });

        // Menu button handlers
        document.getElementById('fabAddCategory')?.addEventListener('click', async () => {
          closeMenu();
          const title = await textInputDialog({ title: '大項目追加', label: '名称' });
          if (title && title.trim()) {
            try { await self.manager.addCategory(title.trim()); showToast('大項目を追加しました'); }
            catch (e) { self.showError('大項目の追加に失敗しました: ' + (e.code || e.message)); }
          }
        });

        document.getElementById('fabAddTask')?.addEventListener('click', async () => {
          closeMenu();
          const categories = self.manager.categories;
          if (categories.length === 0) { showToast('先に大項目を追加してください'); return; }
          const selectedCategoryId = await selectDialog({
            title: '追加先の大項目を選択',
            items: categories.map((c, i) => ({ id: c.id, label: `${i + 1}: ${c.title}` }))
          });
          if (!selectedCategoryId) return;
          const taskName = await textInputDialog({ title: 'タスク追加', label: '名称' });
          if (taskName && taskName.trim()) {
            try { await self.manager.addTask(selectedCategoryId, taskName.trim()); showToast('タスクを追加しました'); }
            catch (e) { self.showError('タスクの追加に失敗しました: ' + (e.code || e.message)); }
          }
        });

        document.getElementById('fabDataManage')?.addEventListener('click', () => {
          closeMenu();
          self.showDataManagementModal();
        });

        document.getElementById('fabSeedData')?.addEventListener('click', async () => {
          closeMenu();
          const confirmed = await confirmDialog('seedHoshitoriData', {
            title: '初期データ投入',
            message: 'サンプルの初期データを投入しますか？\n（既にデータがある場合は投入されません）'
          });
          if (confirmed) {
            try {
              const result = await self.manager.seedInitialData();
              if (result) { showToast('初期データを投入しました'); }
              else { showToast('既にデータが存在するため、投入しませんでした'); }
            }
            catch (e) { self.showError('初期データの投入に失敗しました: ' + (e.code || e.message)); }
          }
        });

        document.getElementById('fabResetConfirm')?.addEventListener('click', () => {
          closeMenu();
          resetConfirmSettings();
        });

        // Keyboard shortcuts (only when modal is active and admin)
        modal.addEventListener('keydown', (e) => {
          if (!self.manager.isAdmin) return;
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
          const key = e.key.toLowerCase();
          if (key === 'g') { e.preventDefault(); toggleMenu(); }
          else if (key === 'escape' && menu.classList.contains('open')) { e.preventDefault(); e.stopPropagation(); closeMenu(); }
          else if (menu.classList.contains('open')) {
            if (key === 'c') { e.preventDefault(); document.getElementById('fabAddCategory')?.click(); }
            else if (key === 't') { e.preventDefault(); document.getElementById('fabAddTask')?.click(); }
            else if (key === 'd') { e.preventDefault(); document.getElementById('fabDataManage')?.click(); }
            else if (key === 's') { e.preventDefault(); document.getElementById('fabSeedData')?.click(); }
            else if (key === 'r') { e.preventDefault(); document.getElementById('fabResetConfirm')?.click(); }
          }
        });
      }
      showDataManagementModal() {
        const categories = this.manager.categories; let listHtml = '<div style="max-height: 300px; overflow-y: auto;">';
        categories.forEach(category => {
          listHtml += `
            <div style="margin-bottom: 16px; padding: 12px; background: #f5f5f7; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <strong>${this.escapeHtml(category.title)}</strong>
                <div>
                  <button class="btn-admin" data-action="edit-category" data-id="${category.id}">編集</button>
                  <button class="btn-admin danger" data-action="delete-category" data-id="${category.id}">削除</button>
                </div>
              </div>
              <ul style="margin: 0; padding-left: 20px;">
          `;
          (category.tasks || []).forEach(task => {
            listHtml += `
              <li style="display: flex; justify-content: space-between; align-items: center; padding: 4px 0;">
                <span>${this.escapeHtml(task.name)}</span>
                <div>
                  <button class="btn-admin" data-action="edit-task" data-category-id="${category.id}" data-task-id="${task.id}" style="font-size: 11px; padding: 2px 8px;">編集</button>
                  <button class="btn-admin danger" data-action="delete-task" data-category-id="${category.id}" data-task-id="${task.id}" style="font-size: 11px; padding: 2px 8px;">削除</button>
                </div>
              </li>
            `;
          });
          listHtml += `</ul></div>`;
        });
        listHtml += '</div>';
        const overlay = document.createElement('div'); overlay.id = 'dataManagementOverlay'; overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 2000;';
        overlay.innerHTML = `
          <div style="background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; max-height: 80vh; overflow: hidden;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h3 style="margin: 0;">データ管理</h3>
              <button id="closeDataManagement" style="border: none; background: #e5e5ea; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 18px;">×</button>
            </div>
            ${listHtml}
          </div>
        `;
        document.body.appendChild(overlay);
        document.getElementById('closeDataManagement').addEventListener('click', () => { overlay.remove(); });
        overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
        overlay.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const action = btn.dataset.action; const categoryId = btn.dataset.id || btn.dataset.categoryId; const taskId = btn.dataset.taskId;
            try {
              switch (action) {
                case 'edit-category': {
                  const cat = this.manager.categories.find(c => c.id === categoryId);
                  const newTitle = await textInputDialog({ title: '大項目編集', label: '名称', defaultValue: cat?.title || '' });
                  if (newTitle && newTitle.trim()) { await this.manager.updateCategoryTitle(categoryId, newTitle.trim()); overlay.remove(); }
                  break; }
                case 'delete-category': {
                  const confirmed = await confirmDialog('deleteCategory', {
                    title: '大項目削除',
                    message: 'この大項目と配下のタスクをすべて削除しますか？',
                    danger: true
                  });
                  if (confirmed) { await this.manager.deleteCategory(categoryId); overlay.remove(); }
                  break; }
                case 'edit-task': {
                  const category = this.manager.categories.find(c => c.id === categoryId);
                  const task = category?.tasks?.find(t => t.id === taskId);
                  const newName = await textInputDialog({ title: 'タスク編集', label: '名称', defaultValue: task?.name || '' });
                  if (newName && newName.trim()) { await this.manager.updateTaskName(categoryId, taskId, newName.trim()); overlay.remove(); }
                  break; }
                case 'delete-task': {
                  const confirmed = await confirmDialog('deleteHoshitoriTask', {
                    title: 'タスク削除',
                    message: 'このタスクを削除しますか？',
                    danger: true
                  });
                  if (confirmed) { await this.manager.deleteTask(categoryId, taskId); overlay.remove(); }
                  break; }
              }
            } catch (e) { this.showError('操作に失敗しました: ' + (e.code || e.message)); }
          });
        });
      }
      async renderLogs() {
        const logs = await this.manager.getRecentLogs(10);
        if (logs.length === 0) { this.elements.logContainer.innerHTML = ''; return; }
        let html = `<div class="operation-log-title">操作ログ（最新10件）</div>`;
        logs.forEach(log => {
          const date = new Date(log.timestamp); const timeStr = date.toLocaleString('ja-JP'); let actionStr = '';
          switch (log.action) {
            case 'TOGGLE_OWNER': actionStr = `${log.details.taskName} の ${log.details.member} を ${log.details.value} に変更`; break;
            case 'ADD_CATEGORY': actionStr = `大項目「${log.details.title}」を追加`; break;
            case 'UPDATE_CATEGORY': actionStr = `大項目を「${log.details.newTitle}」に変更`; break;
            case 'DELETE_CATEGORY': actionStr = `大項目「${log.details.title}」を削除`; break;
            case 'ADD_TASK': actionStr = `タスク「${log.details.taskName}」を追加`; break;
            case 'UPDATE_TASK': actionStr = `タスクを「${log.details.newName}」に変更`; break;
            case 'DELETE_TASK': actionStr = `タスク「${log.details.taskName}」を削除`; break;
            default: actionStr = log.action;
          }
          html += `<div class="log-entry"><span>${timeStr}</span> - <span>${log.user}</span>: <span>${actionStr}</span></div>`;
        });
        this.elements.logContainer.innerHTML = html;
      }
      showError(message) { showToast(message); }
      escapeHtml(str) { if (!str) return ''; return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;'); }
    }

    let hoshitoriManager = null;
    let hoshitoriUI = null;

    const hoshitoriElements = {
      btnOpen: document.getElementById('btnOpenHoshitori'),
      btnClose: document.getElementById('btnCloseHoshitori'),
      modal: document.getElementById('hoshitoriModal'),
      tableWrapper: document.getElementById('hoshitoriTableWrapper'),
      adminPanel: document.getElementById('hoshitoriAdminPanel'),
      logContainer: document.getElementById('hoshitoriLogContainer'),
      lastUpdated: document.getElementById('hoshitoriLastUpdated'),
      userStatus: document.getElementById('hoshitoriUserStatus')
    };

    // 星取管理表初期化
    function initHoshitori() {
      if (!db || !auth) return;

      hoshitoriManager = new HoshitoriManager(db, auth, ADMIN_EMAIL);
      hoshitoriUI = new HoshitoriUI(hoshitoriManager, {
        tableWrapper: hoshitoriElements.tableWrapper,
        adminPanel: hoshitoriElements.adminPanel,
        logContainer: hoshitoriElements.logContainer
      });
    }

    // 星取管理表モーダルを開く
    async function openHoshitoriModal() {
      hoshitoriElements.modal.classList.add('active');
      if (typeof onModalOpen === 'function') onModalOpen();

      if (!hoshitoriManager) {
        initHoshitori();
      }

      if (hoshitoriManager) {
        hoshitoriManager.checkIsAdmin();
        const isHoshitoriAdmin = hoshitoriManager.isAdmin;

        // ステータス表示更新
        hoshitoriElements.userStatus.textContent = isHoshitoriAdmin ? '管理者モード（編集可）' : '閲覧モード';

        // 管理者モードクラス適用
        hoshitoriElements.modal.classList.toggle('admin-mode', isHoshitoriAdmin);

        // 管理パネル表示
        hoshitoriUI.renderAdminPanel();

        // データ購読開始
        await hoshitoriManager.subscribeToData(async (categories) => {
          hoshitoriUI.render(categories);
          hoshitoriElements.lastUpdated.textContent = `最終更新: ${new Date().toLocaleString('ja-JP')}`;

          // ログ表示（管理者のみ）
          if (isHoshitoriAdmin) {
            await hoshitoriUI.renderLogs();
          }
        });
      }
    }

    // 星取管理表モーダルを閉じる
    function closeHoshitoriModal() {
      hoshitoriElements.modal.classList.remove('active');
      if (typeof onModalClose === 'function') onModalClose();
      if (hoshitoriManager) {
        hoshitoriManager.unsubscribeFromData();
      }
    }

    // 星取管理表イベントリスナー
    hoshitoriElements.btnOpen.addEventListener('click', openHoshitoriModal);
    hoshitoriElements.btnClose.addEventListener('click', closeHoshitoriModal);

    hoshitoriElements.modal.addEventListener('click', (e) => {
      if (e.target === hoshitoriElements.modal) {
        closeHoshitoriModal();
      }
    });

    // ESCキーで星取モーダルも閉じる（既存のESCハンドラを拡張）
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (hoshitoriElements.modal.classList.contains('active')) {
          closeHoshitoriModal();
        }
      }
    });

    // ===================================================
    // App Dialog Utilities - prompt/confirm/alert 置換用
    // ===================================================

    // ダイアログルートの初期化（冪等）
    function getDialogRoot() {
      let root = document.getElementById('appDialogRoot');
      if (!root) {
        root = document.createElement('div');
        root.id = 'appDialogRoot';
        document.body.appendChild(root);
      }
      return root;
    }

    // トースト表示
    function showToast(msg, ms = 2500) {
      const existing = document.querySelector('.app-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'app-toast';
      toast.setAttribute('role', 'status');
      toast.setAttribute('aria-live', 'polite');
      toast.textContent = msg;
      document.body.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.add('show');
      });

      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, ms);
    }

    // フォーカストラップ
    function trapFocus(container) {
      const focusable = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
      const first = focusable[0];
      const last = focusable[focusable.length - 1];

      function handleTab(e) {
        if (e.key !== 'Tab') return;
        if (e.shiftKey) {
          if (document.activeElement === first) {
            e.preventDefault();
            last.focus();
          }
        } else {
          if (document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        }
      }
      container.addEventListener('keydown', handleTab);
      return () => container.removeEventListener('keydown', handleTab);
    }

    // 確認ダイアログ
    async function confirmDialog(key, { title, message, confirmText = 'OK', cancelText = 'キャンセル', remember = true, danger = false }) {
      // suppress check
      if (remember && localStorage.getItem('confirm.suppress.' + key) === '1') {
        showToast('確認をスキップ中（設定でリセット可）', 1500);
        return true;
      }

      return new Promise((resolve) => {
        const root = getDialogRoot();
        const dialogId = 'appConfirmDialog_' + Date.now();

        const overlay = document.createElement('div');
        overlay.className = 'app-dialog-overlay';
        overlay.innerHTML = `
          <div class="app-dialog-container" role="dialog" aria-modal="true" aria-labelledby="${dialogId}_title" tabindex="-1">
            <h3 class="app-dialog-title" id="${dialogId}_title">${escapeHtml(title)}</h3>
            <p class="app-dialog-message">${escapeHtml(message)}</p>
            ${remember ? `
              <label class="app-dialog-remember">
                <input type="checkbox" id="${dialogId}_remember">
                次回から確認しない
              </label>
            ` : ''}
            <div class="app-dialog-buttons">
              <button type="button" class="app-dialog-btn app-dialog-btn-cancel" id="${dialogId}_cancel">${escapeHtml(cancelText)}</button>
              <button type="button" class="app-dialog-btn ${danger ? 'app-dialog-btn-danger' : 'app-dialog-btn-confirm'}" id="${dialogId}_confirm">${escapeHtml(confirmText)}</button>
            </div>
          </div>
        `;

        root.appendChild(overlay);

        const container = overlay.querySelector('.app-dialog-container');
        const confirmBtn = document.getElementById(dialogId + '_confirm');
        const cancelBtn = document.getElementById(dialogId + '_cancel');
        const rememberCheck = document.getElementById(dialogId + '_remember');

        const removeTrap = trapFocus(container);
        confirmBtn.focus();

        function close(result) {
          if (result && remember && rememberCheck && rememberCheck.checked) {
            localStorage.setItem('confirm.suppress.' + key, '1');
          }
          removeTrap();
          overlay.remove();
          resolve(result);
        }

        confirmBtn.addEventListener('click', () => close(true));
        cancelBtn.addEventListener('click', () => close(false));
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close(false);
        });
        container.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close(false);
        });
      });
    }

    // テキスト入力ダイアログ
    async function textInputDialog({ title, label, placeholder = '', defaultValue = '', required = true, validator = null }) {
      return new Promise((resolve) => {
        const root = getDialogRoot();
        const dialogId = 'appTextInputDialog_' + Date.now();

        const overlay = document.createElement('div');
        overlay.className = 'app-dialog-overlay';
        overlay.innerHTML = `
          <div class="app-dialog-container" role="dialog" aria-modal="true" aria-labelledby="${dialogId}_title" tabindex="-1">
            <h3 class="app-dialog-title" id="${dialogId}_title">${escapeHtml(title)}</h3>
            <label class="app-dialog-label" for="${dialogId}_input">${escapeHtml(label)}</label>
            <input type="text" class="app-dialog-input" id="${dialogId}_input" placeholder="${escapeHtml(placeholder)}" value="${escapeHtml(defaultValue)}">
            <p class="app-dialog-error" id="${dialogId}_error"></p>
            <div class="app-dialog-buttons">
              <button type="button" class="app-dialog-btn app-dialog-btn-cancel" id="${dialogId}_cancel">キャンセル</button>
              <button type="button" class="app-dialog-btn app-dialog-btn-confirm" id="${dialogId}_confirm">OK</button>
            </div>
          </div>
        `;

        root.appendChild(overlay);

        const container = overlay.querySelector('.app-dialog-container');
        const input = document.getElementById(dialogId + '_input');
        const errorEl = document.getElementById(dialogId + '_error');
        const confirmBtn = document.getElementById(dialogId + '_confirm');
        const cancelBtn = document.getElementById(dialogId + '_cancel');

        const removeTrap = trapFocus(container);
        input.focus();
        input.select();

        function close(value) {
          removeTrap();
          overlay.remove();
          resolve(value);
        }

        function tryConfirm() {
          const value = input.value.trim();
          if (required && !value) {
            input.classList.add('error');
            errorEl.textContent = '入力してください';
            errorEl.classList.add('show');
            input.focus();
            return;
          }
          if (validator) {
            const validationResult = validator(value);
            if (validationResult !== true) {
              input.classList.add('error');
              errorEl.textContent = typeof validationResult === 'string' ? validationResult : '入力が無効です';
              errorEl.classList.add('show');
              input.focus();
              return;
            }
          }
          close(value);
        }

        input.addEventListener('input', () => {
          input.classList.remove('error');
          errorEl.classList.remove('show');
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            tryConfirm();
          }
        });

        confirmBtn.addEventListener('click', tryConfirm);
        cancelBtn.addEventListener('click', () => close(null));
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close(null);
        });
        container.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close(null);
        });
      });
    }

    // 選択ダイアログ
    async function selectDialog({ title, items }) {
      return new Promise((resolve) => {
        const root = getDialogRoot();
        const dialogId = 'appSelectDialog_' + Date.now();

        const itemsHtml = items.map((item, idx) => `
          <button type="button" class="app-dialog-select-item" data-id="${escapeHtml(item.id)}" data-index="${idx}">
            ${escapeHtml(item.label)}
          </button>
        `).join('');

        const overlay = document.createElement('div');
        overlay.className = 'app-dialog-overlay';
        overlay.innerHTML = `
          <div class="app-dialog-container" role="dialog" aria-modal="true" aria-labelledby="${dialogId}_title" tabindex="-1">
            <h3 class="app-dialog-title" id="${dialogId}_title">${escapeHtml(title)}</h3>
            <div class="app-dialog-select-list">
              ${itemsHtml}
            </div>
            <div class="app-dialog-buttons">
              <button type="button" class="app-dialog-btn app-dialog-btn-cancel" id="${dialogId}_cancel">キャンセル</button>
            </div>
          </div>
        `;

        root.appendChild(overlay);

        const container = overlay.querySelector('.app-dialog-container');
        const cancelBtn = document.getElementById(dialogId + '_cancel');
        const selectItems = container.querySelectorAll('.app-dialog-select-item');

        const removeTrap = trapFocus(container);
        if (selectItems.length > 0) selectItems[0].focus();

        function close(value) {
          removeTrap();
          overlay.remove();
          resolve(value);
        }

        selectItems.forEach(btn => {
          btn.addEventListener('click', () => {
            close(btn.dataset.id);
          });
        });

        cancelBtn.addEventListener('click', () => close(null));
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close(null);
        });
        container.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') close(null);
        });
      });
    }

    // 確認設定リセット
    function resetConfirmSettings() {
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('confirm.suppress.')) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      showToast('確認設定をリセットしました');
    }
  </script>
</body>
</html>
