<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>星取進捗ダッシュボード</title>
  <style>
    /* ===================================================
       十式準拠 星取進捗ダッシュボード CSS
       ⑩継：Apple社内ツール風UI（余白・角丸・薄影・タイポ階層）
    =================================================== */

    :root {
      /* ②理：期限ステータス色定義 */
      --color-zetsu: #FF3B30;      /* 絶期限：赤 */
      --color-zetsu-text: #FFFFFF;
      --color-ran: #FFCC00;        /* 乱期限：黄 */
      --color-ran-text: #1D1D1F;
      --color-jun: #007AFF;        /* 循期限：青 */
      --color-jun-text: #FFFFFF;

      /* Apple風ベースカラー */
      --bg-primary: #F5F5F7;
      --bg-secondary: #FFFFFF;
      --bg-modal: rgba(0, 0, 0, 0.5);
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --border-color: #D2D2D7;
      --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
      --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.16);

      /* タイポグラフィ */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
      --font-size-xs: 11px;
      --font-size-sm: 13px;
      --font-size-base: 15px;
      --font-size-lg: 17px;
      --font-size-xl: 22px;
      --font-size-2xl: 28px;

      /* 角丸 */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 14px;
      --radius-xl: 20px;

      /* 余白 */
      --space-xs: 4px;
      --space-sm: 8px;
      --space-md: 16px;
      --space-lg: 24px;
      --space-xl: 32px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--text-primary);
      background: var(--bg-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* ===================================================
       ヘッダー（部署ヘッダー）
    =================================================== */
    .department-header {
      background: var(--bg-secondary);
      padding: var(--space-md) var(--space-lg);
      box-shadow: var(--shadow-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .department-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      color: var(--text-primary);
    }

    .header-actions {
      display: flex;
      gap: var(--space-sm);
      align-items: center;
    }

    /* 星取管理表ボタン - ①認：入口 */
    .btn-hoshitori {
      background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
      color: white;
      border: none;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-light);
    }

    .btn-hoshitori:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .btn-hoshitori:active {
      transform: translateY(0);
    }

    /* ログインボタン */
    .btn-login {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-login:hover {
      background: var(--bg-primary);
    }

    .btn-login.logged-in {
      background: #34C759;
      color: white;
      border-color: #34C759;
    }

    /* ===================================================
       モーダル - ①認：モーダル表示
    =================================================== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-modal);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: var(--space-lg);
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: var(--shadow-heavy);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-primary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--border-color);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      flex: 1;
    }

    /* ===================================================
       期限リストセクション - ③衡：表示バランス
    =================================================== */
    .deadline-section {
      margin-bottom: var(--space-lg);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .section-badge {
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-badge.zetsu {
      background: var(--color-zetsu);
      color: var(--color-zetsu-text);
    }

    .section-badge.ran {
      background: var(--color-ran);
      color: var(--color-ran-text);
    }

    .section-badge.jun {
      background: var(--color-jun);
      color: var(--color-jun-text);
    }

    .section-title {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    .section-count {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin-left: auto;
    }

    /* タスクリスト */
    .task-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-sm);
    }

    .task-list-empty {
      text-align: center;
      padding: var(--space-lg);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      background: var(--bg-primary);
      border-radius: var(--radius-md);
    }

    /* タスクカード */
    .task-card {
      background: var(--bg-primary);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      transition: all 0.2s ease;
    }

    .task-card:hover {
      box-shadow: var(--shadow-light);
    }

    .task-card.zetsu {
      border-left: 4px solid var(--color-zetsu);
    }

    .task-card.ran {
      border-left: 4px solid var(--color-ran);
    }

    .task-card.jun {
      border-left: 4px solid var(--color-jun);
    }

    .task-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: var(--space-sm);
    }

    .task-title {
      font-size: var(--font-size-base);
      font-weight: 500;
      flex: 1;
    }

    .task-title-input {
      font-size: var(--font-size-base);
      font-weight: 500;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: var(--space-xs) var(--space-sm);
      width: 100%;
      font-family: inherit;
    }

    .task-deadline {
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      white-space: nowrap;
      margin-left: var(--space-sm);
    }

    .task-deadline-input {
      font-size: var(--font-size-sm);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: var(--space-xs) var(--space-sm);
      font-family: inherit;
    }

    /* ===================================================
       HPバー風ゲージ - ②理：ポケモンHPバー風
    =================================================== */
    .hp-bar-container {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .hp-bar-label {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      min-width: 20px;
    }

    .hp-bar-wrapper {
      flex: 1;
      height: 8px;
      background: #E5E5EA;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .hp-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease, background 0.3s ease;
    }

    .hp-bar-fill.zetsu {
      background: linear-gradient(90deg, var(--color-zetsu) 0%, #FF6961 100%);
    }

    .hp-bar-fill.ran {
      background: linear-gradient(90deg, var(--color-ran) 0%, #FFE066 100%);
    }

    .hp-bar-fill.jun {
      background: linear-gradient(90deg, var(--color-jun) 0%, #5AC8FA 100%);
    }

    .hp-bar-value {
      font-size: var(--font-size-xs);
      font-weight: 600;
      min-width: 36px;
      text-align: right;
    }

    /* 進捗スライダー（管理者用） */
    .progress-slider {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      background: #E5E5EA;
      outline: none;
      cursor: pointer;
    }

    .progress-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--color-jun);
      box-shadow: var(--shadow-light);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .progress-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .progress-slider.zetsu::-webkit-slider-thumb {
      border-color: var(--color-zetsu);
    }

    .progress-slider.ran::-webkit-slider-thumb {
      border-color: var(--color-ran);
    }

    .progress-slider.jun::-webkit-slider-thumb {
      border-color: var(--color-jun);
    }

    /* Firefox対応 */
    .progress-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 2px solid var(--color-jun);
      box-shadow: var(--shadow-light);
      cursor: pointer;
    }

    /* ===================================================
       区切り線 - ④縁：構造
    =================================================== */
    .section-divider {
      height: 1px;
      background: var(--border-color);
      margin: var(--space-lg) 0;
    }

    /* ===================================================
       管理者用アクション - ⑥許：権限
    =================================================== */
    .admin-actions {
      display: none;
    }

    .admin-mode .admin-actions {
      display: flex;
      gap: var(--space-sm);
    }

    .task-actions {
      display: none;
      gap: var(--space-xs);
      margin-left: var(--space-sm);
    }

    .admin-mode .task-actions {
      display: flex;
    }

    .btn-icon {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      font-size: 14px;
    }

    .btn-icon:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .btn-icon.delete:hover {
      background: #FFEBEE;
      color: var(--color-zetsu);
    }

    .btn-add-task {
      background: var(--bg-secondary);
      border: 2px dashed var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      width: 100%;
      cursor: pointer;
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      transition: all 0.2s ease;
      margin-top: var(--space-md);
    }

    .btn-add-task:hover {
      border-color: var(--color-jun);
      color: var(--color-jun);
      background: rgba(0, 122, 255, 0.05);
    }

    /* ===================================================
       ログインモーダル
    =================================================== */
    .login-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-modal);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      padding: var(--space-lg);
      backdrop-filter: blur(4px);
    }

    .login-modal.active {
      display: flex;
    }

    .login-container {
      background: var(--bg-secondary);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      width: 100%;
      max-width: 360px;
      box-shadow: var(--shadow-heavy);
    }

    .login-title {
      font-size: var(--font-size-xl);
      font-weight: 600;
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: 500;
      margin-bottom: var(--space-xs);
      color: var(--text-secondary);
    }

    .form-input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--color-jun);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .btn-submit {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      background: linear-gradient(180deg, #007AFF 0%, #0056CC 100%);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: var(--space-md);
    }

    .btn-submit:hover {
      opacity: 0.9;
    }

    .btn-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .login-error {
      color: var(--color-zetsu);
      font-size: var(--font-size-sm);
      text-align: center;
      margin-top: var(--space-sm);
      display: none;
    }

    .login-error.show {
      display: block;
    }

    .login-close {
      position: absolute;
      top: var(--space-md);
      right: var(--space-md);
      width: 32px;
      height: 32px;
      border: none;
      background: var(--bg-primary);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--text-secondary);
    }

    /* ===================================================
       ローディング
    =================================================== */
    .loading {
      text-align: center;
      padding: var(--space-xl);
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--bg-primary);
      border-top-color: var(--color-jun);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-md);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===================================================
       フッター情報
    =================================================== */
    .modal-footer {
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-color);
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      text-align: center;
      flex-shrink: 0;
    }

    /* ===================================================
       レスポンシブ - ⑧乱対応
    =================================================== */
    @media (max-width: 640px) {
      .modal-container {
        max-height: 100vh;
        border-radius: 0;
      }

      .modal-body {
        padding: var(--space-md);
      }

      .task-header {
        flex-direction: column;
        gap: var(--space-xs);
      }

      .task-deadline {
        margin-left: 0;
      }

      .department-header {
        padding: var(--space-sm) var(--space-md);
      }

      .department-title {
        font-size: var(--font-size-lg);
      }
    }

    /* ===================================================
       メインコンテンツ（ダミー）
    =================================================== */
    .main-content {
      padding: var(--space-xl);
      max-width: 1200px;
      margin: 0 auto;
    }

    .placeholder-card {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-light);
      text-align: center;
      color: var(--text-secondary);
    }

    /* ===================================================
       タスク残り日数表示
    =================================================== */
    .task-remaining {
      font-size: var(--font-size-xs);
      color: var(--text-secondary);
      margin-top: var(--space-xs);
    }

    .task-remaining.overdue {
      color: var(--color-zetsu);
      font-weight: 500;
    }

    /* メインハイライト（絶期限・乱期限常時表示） */
    .main-highlights {
      margin-bottom: var(--space-lg);
    }

    .main-highlights .deadline-section {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      box-shadow: var(--shadow-light);
      margin-bottom: var(--space-md);
    }

    .main-highlights .section-header {
      margin-bottom: var(--space-md);
    }

    .main-highlights-empty {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      box-shadow: var(--shadow-light);
      text-align: center;
      color: var(--text-secondary);
    }
  </style>
  <link rel="stylesheet" href="./src/hoshitori/hoshitori.css">
</head>
<body>
  <!-- ===================================================
       部署ヘッダー - ①認：入口
  =================================================== -->
  <header class="department-header">
    <h1 class="department-title">企画部</h1>
    <div class="header-actions">
      <button class="btn-hoshitori-table" id="btnOpenHoshitori">
        ★ 星取管理表
      </button>
      <button class="btn-hoshitori" id="btnOpenDashboard">
        進捗管理表
      </button>
      <button class="btn-login" id="btnLogin">
        ログイン
      </button>
    </div>
  </header>

  <!-- メインコンテンツ -->
  <main class="main-content">
    <!-- 絶期限・乱期限ハイライト表示 -->
    <section id="mainHighlights" class="main-highlights">
      <div class="loading">
        <div class="loading-spinner"></div>
        <p>読み込み中...</p>
      </div>
    </section>
  </main>

  <!-- ===================================================
       ダッシュボードモーダル - ①認：モーダル表示
  =================================================== -->
  <div class="modal-overlay" id="dashboardModal">
    <div class="modal-container">
      <header class="modal-header">
        <h2 class="modal-title">星取進捗ダッシュボード</h2>
        <button class="modal-close" id="btnCloseDashboard">×</button>
      </header>

      <div class="modal-body" id="dashboardContent">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>読み込み中...</p>
        </div>
      </div>

      <footer class="modal-footer">
        <span id="lastUpdated">最終更新: --</span>
        <span style="margin: 0 8px;">|</span>
        <span id="userStatus">閲覧モード</span>
      </footer>
    </div>
  </div>

  <!-- ===================================================
       星取管理表モーダル - 業務担当一覧表
  =================================================== -->
  <div class="hoshitori-modal" id="hoshitoriModal">
    <div class="hoshitori-container">
      <header class="hoshitori-header">
        <h2 class="hoshitori-title">星取管理表（業務担当一覧）</h2>
        <button class="modal-close" id="btnCloseHoshitori">×</button>
      </header>

      <div class="hoshitori-body">
        <div class="hoshitori-table-wrapper" id="hoshitoriTableWrapper">
          <div class="hoshitori-loading">
            <div class="loading-spinner"></div>
            <p>読み込み中...</p>
          </div>
        </div>

        <div class="admin-panel" id="hoshitoriAdminPanel"></div>

        <div class="operation-log" id="hoshitoriLogContainer"></div>
      </div>

      <footer class="hoshitori-footer">
        <span id="hoshitoriLastUpdated">最終更新: --</span>
        <span id="hoshitoriUserStatus">閲覧モード</span>
      </footer>
    </div>
  </div>

  <!-- ===================================================
       ログインモーダル - ⑥許：認証
  =================================================== -->
  <div class="login-modal" id="loginModal">
    <div class="login-container" style="position: relative;">
      <button class="login-close" id="btnCloseLogin">×</button>
      <h2 class="login-title">管理者ログイン</h2>
      <form id="loginForm">
        <div class="form-group">
          <label class="form-label">メールアドレス</label>
          <input type="email" class="form-input" id="loginEmail" required>
        </div>
        <div class="form-group">
          <label class="form-label">パスワード</label>
          <input type="password" class="form-input" id="loginPassword" required>
        </div>
        <button type="submit" class="btn-submit" id="btnSubmitLogin">ログイン</button>
        <p class="login-error" id="loginError">ログインに失敗しました</p>
      </form>
    </div>
  </div>

  <!-- ===================================================
       Firebase SDK & アプリケーションロジック
       ⑤幅：Firebase無料枠、Vanilla JS
  =================================================== -->
  <script type="module">
    // ===================================================
    // Firebase設定 - ⑤幅：単一ソースからインポート
    // ===================================================
    import { FIREBASE_CONFIG } from './src/firebase/firebase-config.js';

    // ===================================================
    // 分類閾値定数 - ②理：調整可能な境界値
    // Δ = 実際進捗 - 期待進捗
    // ===================================================
    const THRESHOLD = {
      ZETSU: -20,  // Δ < -20% → 絶（進捗に対し期限が明らかに不足）
      RAN: -5      // -20% ≤ Δ < -5% → 乱（間に合うか不明）
                   // Δ ≥ -5% → 循（進捗に対し期限に余裕）
    };

    // ===================================================
    // 管理者メールアドレス - ⑥許：管理者1名のみ編集可
    // ===================================================
    const ADMIN_EMAIL = "shiozaki@newcom07.jp";

    // ===================================================
    // Firebase SDK 動的インポート
    // ===================================================
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      deleteDoc,
      doc,
      query,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // ===================================================
    // アプリケーション状態
    // ===================================================
    let app, auth, db;
    let currentUser = null;
    let isAdmin = false;
    let tasks = [];

    // ===================================================
    // DOM要素
    // ===================================================
    const elements = {
      btnOpenDashboard: document.getElementById('btnOpenDashboard'),
      btnCloseDashboard: document.getElementById('btnCloseDashboard'),
      dashboardModal: document.getElementById('dashboardModal'),
      dashboardContent: document.getElementById('dashboardContent'),
      btnLogin: document.getElementById('btnLogin'),
      btnCloseLogin: document.getElementById('btnCloseLogin'),
      loginModal: document.getElementById('loginModal'),
      loginForm: document.getElementById('loginForm'),
      loginEmail: document.getElementById('loginEmail'),
      loginPassword: document.getElementById('loginPassword'),
      loginError: document.getElementById('loginError'),
      btnSubmitLogin: document.getElementById('btnSubmitLogin'),
      lastUpdated: document.getElementById('lastUpdated'),
      userStatus: document.getElementById('userStatus'),
      mainHighlights: document.getElementById('mainHighlights')
    };

    // ===================================================
    // 初期化
    // ===================================================
    function initFirebase() {
      try {
        app = initializeApp(FIREBASE_CONFIG);
        auth = getAuth(app);
        db = getFirestore(app);

        // 認証状態監視 - ⑥許：権限管理
        onAuthStateChanged(auth, (user) => {
          currentUser = user;
          isAdmin = user && user.email === ADMIN_EMAIL;
          updateAuthUI();
          renderMainHighlights();
          if (elements.dashboardModal.classList.contains('active')) {
            renderDashboard();
          }
        });

        console.log('Firebase initialized');
        renderMainHighlights();
      } catch (error) {
        console.error('Firebase initialization error:', error);
      }
    }

    // ===================================================
    // 認証UI更新 - ⑥許
    // ===================================================
    function updateAuthUI() {
      const btn = elements.btnLogin;
      if (currentUser) {
        btn.textContent = 'ログアウト';
        btn.classList.add('logged-in');
        elements.userStatus.textContent = isAdmin ? '管理者モード' : '閲覧モード';
      } else {
        btn.textContent = 'ログイン';
        btn.classList.remove('logged-in');
        elements.userStatus.textContent = '閲覧モード';
      }

      // 管理者モードクラス切り替え
      document.body.classList.toggle('admin-mode', isAdmin);
    }

    // ===================================================
    // 分類ロジック - ②理：期限ステータス判定
    // Δ = P（実際進捗） - 期待進捗
    // 期待進捗 = 100 × (経過日数 / 期限総日数)
    // ===================================================
    function classifyTask(task) {
      // 期限なしタスクは分類しない - ③衡
      if (!task.deadline) return null;

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const deadline = new Date(task.deadline);
      deadline.setHours(0, 0, 0, 0);

      // 開始日がない場合は作成日または30日前と仮定
      let startDate;
      if (task.startDate) {
        startDate = new Date(task.startDate);
      } else if (task.createdAt) {
        startDate = new Date(task.createdAt);
      } else {
        // 期限から30日前をデフォルトの開始日とする
        startDate = new Date(deadline.getTime() - 30 * 24 * 60 * 60 * 1000);
      }
      startDate.setHours(0, 0, 0, 0);

      // 期限総日数（最低1日）
      const totalDays = Math.max(1, (deadline - startDate) / (24 * 60 * 60 * 1000));

      // 経過日数（開始前はマイナス、開始後はプラス）
      const elapsedDays = (today - startDate) / (24 * 60 * 60 * 1000);

      // まだ開始日前の場合
      if (elapsedDays < 0) {
        return 'jun'; // 余裕あり
      }

      // 期待進捗率（%）
      const expectedProgress = Math.min(100, (elapsedDays / totalDays) * 100);

      // 乖離Δ = 実際進捗 - 期待進捗
      const delta = task.progress - expectedProgress;

      // 分類判定 - ②理
      if (delta < THRESHOLD.ZETSU) {
        return 'zetsu';  // 絶：進捗に対し期限が明らかに不足
      } else if (delta < THRESHOLD.RAN) {
        return 'ran';    // 乱：間に合うか不明（危険域）
      } else {
        return 'jun';    // 循：進捗に対し期限に余裕
      }
    }

    // ===================================================
    // タスク取得 - ④縁：データ構造
    // ===================================================
    async function fetchTasks() {
      try {
        const q = query(collection(db, 'tasks'), orderBy('deadline'));
        const snapshot = await getDocs(q);
        tasks = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        return tasks;
      } catch (error) {
        console.error('Error fetching tasks:', error);
        return [];
      }
    }

    // ===================================================
    // ダッシュボードレンダリング - ③衡・④縁
    // 画面上部：絶期限 → 乱期限（最優先で可視化）
    // その下：期限ありタスク一覧（循・乱混在、色で判別）
    // ===================================================
    async function renderDashboard() {
      elements.dashboardContent.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>読み込み中...</p>
        </div>
      `;

      await fetchTasks();

      // 期限ありタスクのみフィルタ - ③衡：期限なしタスクは表示しない
      const tasksWithDeadline = tasks.filter(t => t.deadline);

      // 分類
      const zetsuTasks = [];
      const ranTasks = [];
      const junTasks = [];

      tasksWithDeadline.forEach(task => {
        const status = classifyTask(task);
        task.status = status;
        if (status === 'zetsu') zetsuTasks.push(task);
        else if (status === 'ran') ranTasks.push(task);
        else junTasks.push(task);
      });

      // 並び替え（期限が近い順）
      const sortByDeadline = (a, b) => new Date(a.deadline) - new Date(b.deadline);
      zetsuTasks.sort(sortByDeadline);
      ranTasks.sort(sortByDeadline);
      junTasks.sort(sortByDeadline);

      let html = '';

      // ③衡：画面上部に絶期限
      html += renderSection('絶期限', 'zetsu', zetsuTasks, '進捗に対し期限が明らかに不足');

      // ③衡：次に乱期限
      html += renderSection('乱期限', 'ran', ranTasks, '間に合うか不明（危険域）');

      // ④縁：区切り線
      html += '<div class="section-divider"></div>';

      // ③衡：期限ありタスク一覧（全件、循・乱混在）
      html += `
        <div class="deadline-section">
          <div class="section-header">
            <h3 class="section-title">期限ありタスク一覧</h3>
            <span class="section-count">${tasksWithDeadline.length}件</span>
          </div>
          <div class="task-list">
            ${tasksWithDeadline.length === 0
              ? '<div class="task-list-empty">タスクがありません</div>'
              : tasksWithDeadline.map(t => renderTaskCard(t)).join('')
            }
          </div>
          ${isAdmin ? '<button class="btn-add-task" id="btnAddTask">+ 新しいタスクを追加</button>' : ''}
        </div>
      `;

      elements.dashboardContent.innerHTML = html;
      elements.lastUpdated.textContent = `最終更新: ${new Date().toLocaleString('ja-JP')}`;

      // イベントリスナー設定
      setupEventListeners();
    }

    // ===================================================
    // メインハイライト表示 - 絶期限・乱期限を常時表示
    // ===================================================
    async function renderMainHighlights() {
      if (!elements.mainHighlights) return;

      try {
        await fetchTasks();

        const tasksWithDeadline = tasks.filter(t => t.deadline);
        const zetsuTasks = [];
        const ranTasks = [];

        tasksWithDeadline.forEach(task => {
          const status = classifyTask(task);
          task.status = status;
          if (status === 'zetsu') zetsuTasks.push(task);
          else if (status === 'ran') ranTasks.push(task);
        });

        const sortByDeadline = (a, b) => new Date(a.deadline) - new Date(b.deadline);
        zetsuTasks.sort(sortByDeadline);
        ranTasks.sort(sortByDeadline);

        let html = '';

        // 絶期限・乱期限がどちらもない場合
        if (zetsuTasks.length === 0 && ranTasks.length === 0) {
          html = `
            <div class="main-highlights-empty">
              <p>現在、緊急度の高いタスクはありません</p>
              <p style="margin-top: 8px; font-size: 13px;">「進捗管理表」で全タスクを確認できます</p>
            </div>
          `;
        } else {
          html += renderSection('絶期限', 'zetsu', zetsuTasks, '進捗に対し期限が明らかに不足');
          html += renderSection('乱期限', 'ran', ranTasks, '間に合うか不明（危険域）');
        }

        elements.mainHighlights.innerHTML = html;

        // 管理者モードクラス適用
        elements.mainHighlights.classList.toggle('admin-mode', isAdmin);

        // メイン領域のイベントリスナー設定（管理者編集用）
        setupMainHighlightsEventListeners();
      } catch (error) {
        console.error('renderMainHighlights error:', error);
        elements.mainHighlights.innerHTML = `
          <div class="main-highlights-empty">
            <p>データの読み込みに失敗しました</p>
          </div>
        `;
      }
    }

    // メインハイライト用イベントリスナー
    function setupMainHighlightsEventListeners() {
      if (!elements.mainHighlights) return;

      // 進捗スライダー
      elements.mainHighlights.querySelectorAll('.progress-slider').forEach(slider => {
        slider.addEventListener('input', (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          card.querySelector('.hp-bar-value').textContent = `${value}%`;

          const task = tasks.find(t => t.id === taskId);
          if (task) {
            task.progress = value;
            const newStatus = classifyTask(task);
            card.className = `task-card ${newStatus}`;
            e.target.className = `progress-slider ${newStatus}`;
          }
        });

        slider.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          await updateTask(taskId, { progress: value });
          await renderMainHighlights();
        });
      });

      // タイトル編集
      elements.mainHighlights.querySelectorAll('.task-title-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          await updateTask(taskId, { title: e.target.value });
          await renderMainHighlights();
        });
      });

      // 期限編集
      elements.mainHighlights.querySelectorAll('.task-deadline-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const deadline = e.target.value || null;
          await updateTask(taskId, { deadline });
          await renderMainHighlights();
        });
      });

      // 削除ボタン
      elements.mainHighlights.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          if (confirm('このタスクを削除しますか？')) {
            await deleteTask(taskId);
            await renderMainHighlights();
          }
        });
      });
    }

    // ===================================================
    // セクションレンダリング - ④縁
    // ===================================================
    function renderSection(title, status, tasks, description) {
      return `
        <div class="deadline-section">
          <div class="section-header">
            <span class="section-badge ${status}">${status.toUpperCase()}</span>
            <h3 class="section-title">${title}</h3>
            <span class="section-count">${tasks.length}件</span>
          </div>
          <div class="task-list">
            ${tasks.length === 0
              ? `<div class="task-list-empty">該当するタスクはありません</div>`
              : tasks.map(t => renderTaskCard(t)).join('')
            }
          </div>
        </div>
      `;
    }

    // ===================================================
    // タスクカードレンダリング - ②理：HPバー風ゲージ
    // ===================================================
    function renderTaskCard(task) {
      const status = task.status || 'jun';
      const progress = task.progress || 0;
      const deadlineStr = task.deadline
        ? new Date(task.deadline).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })
        : '期限なし';

      // 残り日数計算
      let remainingText = '';
      let isOverdue = false;
      if (task.deadline) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const deadline = new Date(task.deadline);
        deadline.setHours(0, 0, 0, 0);
        const remainingDays = Math.ceil((deadline - today) / (24 * 60 * 60 * 1000));

        if (remainingDays < 0) {
          remainingText = `${Math.abs(remainingDays)}日超過`;
          isOverdue = true;
        } else if (remainingDays === 0) {
          remainingText = '本日期限';
        } else {
          remainingText = `残り${remainingDays}日`;
        }
      }

      // ⑥許：管理者のみ編集可能なUIを表示
      if (isAdmin) {
        return `
          <div class="task-card ${status}" data-id="${task.id}">
            <div class="task-header">
              <input type="text" class="task-title-input" value="${escapeHtml(task.title)}" data-field="title">
              <input type="date" class="task-deadline-input" value="${task.deadline || ''}" data-field="deadline">
              <div class="task-actions">
                <button class="btn-icon delete" data-action="delete" title="削除">✕</button>
              </div>
            </div>
            <div class="hp-bar-container">
              <span class="hp-bar-label">HP</span>
              <input type="range" class="progress-slider ${status}" min="0" max="100" value="${progress}" data-field="progress">
              <span class="hp-bar-value">${progress}%</span>
            </div>
            <div class="task-remaining ${isOverdue ? 'overdue' : ''}">${remainingText}</div>
          </div>
        `;
      } else {
        // 閲覧モード：編集不可
        return `
          <div class="task-card ${status}" data-id="${task.id}">
            <div class="task-header">
              <span class="task-title">${escapeHtml(task.title)}</span>
              <span class="task-deadline">${deadlineStr}</span>
            </div>
            <div class="hp-bar-container">
              <span class="hp-bar-label">HP</span>
              <div class="hp-bar-wrapper">
                <div class="hp-bar-fill ${status}" style="width: ${progress}%"></div>
              </div>
              <span class="hp-bar-value">${progress}%</span>
            </div>
            <div class="task-remaining ${isOverdue ? 'overdue' : ''}">${remainingText}</div>
          </div>
        `;
      }
    }

    // ===================================================
    // イベントリスナー設定 - ⑥許：管理者のみ編集
    // ===================================================
    function setupEventListeners() {
      // 進捗スライダー（即時色・分類更新）
      document.querySelectorAll('.progress-slider').forEach(slider => {
        // input: リアルタイム更新（ドラッグ中）
        slider.addEventListener('input', (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);

          // 即時UI更新
          card.querySelector('.hp-bar-value').textContent = `${value}%`;

          // 分類再計算
          const task = tasks.find(t => t.id === taskId);
          if (task) {
            task.progress = value;
            const newStatus = classifyTask(task);

            // 色更新
            card.className = `task-card ${newStatus}`;
            e.target.className = `progress-slider ${newStatus}`;
          }
        });

        // change: ドラッグ終了時にFirebase更新
        slider.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const value = parseInt(e.target.value);
          await updateTask(taskId, { progress: value });
          await renderMainHighlights();
        });
      });

      // タイトル編集
      document.querySelectorAll('.task-title-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          await updateTask(taskId, { title: e.target.value });
          await renderMainHighlights();
        });
      });

      // 期限編集
      document.querySelectorAll('.task-deadline-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          const deadline = e.target.value || null;
          await updateTask(taskId, { deadline });
          // 分類が変わる可能性があるので再レンダリング
          renderDashboard();
          renderMainHighlights();
        });
      });

      // 削除ボタン
      document.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const card = e.target.closest('.task-card');
          const taskId = card.dataset.id;
          if (confirm('このタスクを削除しますか？')) {
            await deleteTask(taskId);
            renderDashboard();
            renderMainHighlights();
          }
        });
      });

      // タスク追加ボタン
      const btnAddTask = document.getElementById('btnAddTask');
      if (btnAddTask) {
        btnAddTask.addEventListener('click', async () => {
          const title = prompt('タスク名を入力してください:');
          if (title && title.trim()) {
            const deadline = prompt('期限を入力してください (YYYY-MM-DD形式、空欄可):');
            await addTask({
              title: title.trim(),
              progress: 0,
              deadline: deadline && isValidDate(deadline) ? deadline : null,
              createdAt: new Date().toISOString()
            });
            renderDashboard();
            renderMainHighlights();
          }
        });
      }
    }

    // ===================================================
    // 日付バリデーション
    // ===================================================
    function isValidDate(dateString) {
      const regex = /^\d{4}-\d{2}-\d{2}$/;
      if (!regex.test(dateString)) return false;
      const date = new Date(dateString);
      return date instanceof Date && !isNaN(date);
    }

    // ===================================================
    // タスクCRUD操作 - ⑥許
    // ===================================================
    function getFirestoreErrorMessage(error) {
      const code = error.code || '';
      if (code === 'permission-denied') {
        return '権限がありません。Firestoreルールで書き込みが許可されていません';
      } else if (code === 'failed-precondition') {
        return '前提条件エラー。Firestoreが未初期化/無効な操作の可能性';
      } else if (code === 'unavailable' || code === 'network-request-failed') {
        return 'ネットワークまたはサービス一時障害';
      } else if (code === 'unauthenticated') {
        return '認証されていません。ログインしてください';
      } else if (code === 'not-found') {
        return '対象のドキュメントが見つかりません';
      }
      return '予期しないエラーが発生しました';
    }

    async function addTask(taskData) {
      try {
        await addDoc(collection(db, 'tasks'), taskData);
      } catch (error) {
        console.error('Error adding task:', error);
        const msg = getFirestoreErrorMessage(error);
        alert('タスクの追加に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    async function updateTask(taskId, updates) {
      try {
        await updateDoc(doc(db, 'tasks', taskId), updates);
      } catch (error) {
        console.error('Error updating task:', error);
        const msg = getFirestoreErrorMessage(error);
        alert('タスクの更新に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    async function deleteTask(taskId) {
      try {
        await deleteDoc(doc(db, 'tasks', taskId));
      } catch (error) {
        console.error('Error deleting task:', error);
        const msg = getFirestoreErrorMessage(error);
        alert('タスクの削除に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    // ===================================================
    // 初期データ投入 - ⑦循：運用のための初期データ
    // ===================================================
    async function seedInitialData() {
      try {
        const snapshot = await getDocs(collection(db, 'tasks'));
        if (snapshot.empty) {
          const today = new Date();
          const initialTasks = [
            {
              title: '四半期レポート作成',
              progress: 30,
              deadline: getDateString(7),
              createdAt: getDateString(-14)
            },
            {
              title: 'クライアントA提案書',
              progress: 75,
              deadline: getDateString(14),
              createdAt: getDateString(-7)
            },
            {
              title: '新規営業リスト作成',
              progress: 10,
              deadline: getDateString(3),
              createdAt: getDateString(-10)
            },
            {
              title: '月次会議資料準備',
              progress: 90,
              deadline: getDateString(5),
              createdAt: getDateString(-3)
            },
            {
              title: '顧客満足度調査',
              progress: 50,
              deadline: getDateString(21),
              createdAt: getDateString(-5)
            }
          ];

          for (const task of initialTasks) {
            await addDoc(collection(db, 'tasks'), task);
          }
          console.log('Initial data seeded');
          await renderMainHighlights();
        }
      } catch (error) {
        console.error('Error seeding data:', error);
        const msg = getFirestoreErrorMessage(error);
        alert('初期データ投入に失敗しました: ' + msg + ' (' + error.code + ')');
      }
    }

    function getDateString(daysFromNow) {
      const date = new Date();
      date.setDate(date.getDate() + daysFromNow);
      return date.toISOString().split('T')[0];
    }

    // ===================================================
    // ユーティリティ - ⑨絶：XSS対策
    // ===================================================
    function escapeHtml(str) {
      if (!str) return '';
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // ===================================================
    // モーダル制御 - ①認：入口
    // ===================================================
    elements.btnOpenDashboard.addEventListener('click', () => {
      elements.dashboardModal.classList.add('active');
      renderDashboard();
    });

    elements.btnCloseDashboard.addEventListener('click', () => {
      elements.dashboardModal.classList.remove('active');
    });

    elements.dashboardModal.addEventListener('click', (e) => {
      if (e.target === elements.dashboardModal) {
        elements.dashboardModal.classList.remove('active');
      }
    });

    // ESCキーでモーダルを閉じる
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        elements.dashboardModal.classList.remove('active');
        elements.loginModal.classList.remove('active');
      }
    });

    // ===================================================
    // ログイン制御 - ⑥許：認証
    // ===================================================
    elements.btnLogin.addEventListener('click', () => {
      if (currentUser) {
        signOut(auth);
      } else {
        elements.loginModal.classList.add('active');
      }
    });

    elements.btnCloseLogin.addEventListener('click', () => {
      elements.loginModal.classList.remove('active');
      elements.loginError.classList.remove('show');
    });

    elements.loginModal.addEventListener('click', (e) => {
      if (e.target === elements.loginModal) {
        elements.loginModal.classList.remove('active');
        elements.loginError.classList.remove('show');
      }
    });

    elements.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      elements.btnSubmitLogin.disabled = true;
      elements.loginError.classList.remove('show');

      try {
        await signInWithEmailAndPassword(
          auth,
          elements.loginEmail.value,
          elements.loginPassword.value
        );
        elements.loginModal.classList.remove('active');
        elements.loginForm.reset();
      } catch (error) {
        console.error('Login error:', error);
        let errorMessage = 'ログインに失敗しました';
        if (error.code === 'auth/invalid-api-key') {
          errorMessage = 'Firebase設定(APIキー)が不正です';
        } else if (error.code === 'auth/operation-not-supported-in-this-environment') {
          errorMessage = 'この環境では実行できません。HTTPサーバで配信してください';
        } else if (error.code === 'auth/unauthorized-domain') {
          errorMessage = '許可されていないドメインです。Firebaseの許可ドメインに追加してください';
        } else if (error.code === 'auth/network-request-failed') {
          errorMessage = 'ネットワークエラーが発生しました';
        } else if (error.code === 'auth/user-not-found') {
          errorMessage = 'ユーザーが見つかりません';
        } else if (error.code === 'auth/wrong-password') {
          errorMessage = 'パスワードが正しくありません';
        } else if (error.code === 'auth/invalid-email') {
          errorMessage = 'メールアドレスの形式が正しくありません';
        } else if (error.code === 'auth/invalid-credential') {
          errorMessage = '認証情報が無効です';
        }
        elements.loginError.textContent = errorMessage + ' (' + error.code + ')';
        elements.loginError.classList.add('show');
      } finally {
        elements.btnSubmitLogin.disabled = false;
      }
    });

    // ===================================================
    // アプリケーション起動
    // ===================================================
    initFirebase();

    // 初期データ投入（Firebase接続確認後、管理者のみ実行）
    setTimeout(() => {
      if (db && isAdmin) {
        seedInitialData();
      }
    }, 2000);

    // ===================================================
    // 星取管理表モジュール
    // ===================================================
    import { HoshitoriManager, HoshitoriUI } from './src/hoshitori/hoshitori.js';

    let hoshitoriManager = null;
    let hoshitoriUI = null;

    const hoshitoriElements = {
      btnOpen: document.getElementById('btnOpenHoshitori'),
      btnClose: document.getElementById('btnCloseHoshitori'),
      modal: document.getElementById('hoshitoriModal'),
      tableWrapper: document.getElementById('hoshitoriTableWrapper'),
      adminPanel: document.getElementById('hoshitoriAdminPanel'),
      logContainer: document.getElementById('hoshitoriLogContainer'),
      lastUpdated: document.getElementById('hoshitoriLastUpdated'),
      userStatus: document.getElementById('hoshitoriUserStatus')
    };

    // 星取管理表初期化
    function initHoshitori() {
      if (!db || !auth) return;

      hoshitoriManager = new HoshitoriManager(db, auth, ADMIN_EMAIL);
      hoshitoriUI = new HoshitoriUI(hoshitoriManager, {
        tableWrapper: hoshitoriElements.tableWrapper,
        adminPanel: hoshitoriElements.adminPanel,
        logContainer: hoshitoriElements.logContainer
      });
    }

    // 星取管理表モーダルを開く
    async function openHoshitoriModal() {
      hoshitoriElements.modal.classList.add('active');

      if (!hoshitoriManager) {
        initHoshitori();
      }

      if (hoshitoriManager) {
        hoshitoriManager.checkIsAdmin();
        const isHoshitoriAdmin = hoshitoriManager.isAdmin;

        // ステータス表示更新
        hoshitoriElements.userStatus.textContent = isHoshitoriAdmin ? '管理者モード（編集可）' : '閲覧モード';

        // 管理者モードクラス適用
        hoshitoriElements.modal.classList.toggle('admin-mode', isHoshitoriAdmin);

        // 管理パネル表示
        hoshitoriUI.renderAdminPanel();

        // データ購読開始
        await hoshitoriManager.subscribeToData(async (categories) => {
          hoshitoriUI.render(categories);
          hoshitoriElements.lastUpdated.textContent = `最終更新: ${new Date().toLocaleString('ja-JP')}`;

          // ログ表示（管理者のみ）
          if (isHoshitoriAdmin) {
            await hoshitoriUI.renderLogs();
          }
        });
      }
    }

    // 星取管理表モーダルを閉じる
    function closeHoshitoriModal() {
      hoshitoriElements.modal.classList.remove('active');
      if (hoshitoriManager) {
        hoshitoriManager.unsubscribeFromData();
      }
    }

    // 星取管理表イベントリスナー
    hoshitoriElements.btnOpen.addEventListener('click', openHoshitoriModal);
    hoshitoriElements.btnClose.addEventListener('click', closeHoshitoriModal);

    hoshitoriElements.modal.addEventListener('click', (e) => {
      if (e.target === hoshitoriElements.modal) {
        closeHoshitoriModal();
      }
    });

    // ESCキーで星取モーダルも閉じる（既存のESCハンドラを拡張）
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (hoshitoriElements.modal.classList.contains('active')) {
          closeHoshitoriModal();
        }
      }
    });
  </script>
</body>
</html>
